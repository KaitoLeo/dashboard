<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết Doanh thu hôm nay - Actiwell Reports</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="../assets/css/style.css" rel="stylesheet" />

    <!-- Revenue Calculation Modules -->
    <script src="../assets/js/revenue/revenue-calculations.js"></script>
    <script src="../assets/js/revenue/revenue-mock-data.js"></script>

    <!-- Shared data layer -->
    <script src="../assets/js/shared/constants.js" defer></script>
    <script src="../assets/js/shared/time-utils.js" defer></script>
    <script src="../assets/js/shared/state.js" defer></script>
    <script src="../assets/js/shared/persist.js" defer></script>
    <script src="../assets/js/shared/compute.js" defer></script>
    <script src="../assets/js/shared/sync.js" defer></script>
    <script src="../assets/js/shared/navigation.js" defer></script>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="../index.html">
          <i class="fas fa-arrow-left me-2"></i>
          <i class="fas fa-heartbeat me-2"></i>
          Actiwell Reports
        </a>
        <div class="navbar-nav ms-auto">
          <a
            class="nav-link"
            href="#"
            onclick="Navigation.navigateTo('../index.html'); return false;"
          >
            <i class="fas fa-arrow-left me-1"></i>Quay lại Dashboard
          </a>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h2 class="card-title">
                <i class="fas fa-calendar-day me-2 text-primary"></i>
                Chi tiết Doanh thu hôm nay
              </h2>
              <p class="text-muted">
                Doanh thu chi tiết hôm nay và so sánh với các ngày trước
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Today Revenue Overview -->
      <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card bg-primary text-white">
            <div class="card-body text-center">
              <i class="fas fa-calendar-day fa-2x mb-2"></i>
              <h6>Doanh thu hôm nay</h6>
              <h3 id="todayRevenue">80,434,783</h3>
              <small>VNĐ</small>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <i class="fas fa-chart-line fa-2x mb-2"></i>
              <h6>Tăng trưởng</h6>
              <h3 id="growthRate">+15.2%</h3>
              <small>so với hôm qua</small>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card bg-warning text-white">
            <div class="card-body text-center">
              <i class="fas fa-target fa-2x mb-2"></i>
              <h6>Mục tiêu ngày</h6>
              <h3 id="dailyTarget">100,000,000</h3>
              <small>VNĐ</small>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <i class="fas fa-percentage fa-2x mb-2"></i>
              <h6>Hoàn thành</h6>
              <h3 id="completionRate">80.4%</h3>
              <small>mục tiêu ngày</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Revenue by Service -->
      <div class="row mb-4">
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-chart-pie me-2"></i>Doanh thu theo dịch vụ
              </h5>
            </div>
            <div class="card-body">
              <canvas id="serviceRevenueChart" height="300"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-building me-2"></i>Doanh thu theo cơ sở
              </h5>
            </div>
            <div class="card-body">
              <canvas id="locationRevenueChart" height="300"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Hourly Revenue Trend -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>Xu hướng doanh thu theo
                giờ
              </h5>
            </div>
            <div class="card-body">
              <canvas id="hourlyRevenueChart" height="100"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Revenue Comparison -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-balance-scale me-2"></i>So sánh với các ngày
                trước
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Ngày</th>
                      <th>Doanh thu</th>
                      <th>Thay đổi</th>
                      <th>Tỷ lệ</th>
                      <th>Trạng thái</th>
                    </tr>
                  </thead>
                  <tbody id="comparisonTable">
                    <tr>
                      <td><strong>Hôm nay</strong></td>
                      <td><strong>80,434,783 VNĐ</strong></td>
                      <td><span class="text-success">+15.2%</span></td>
                      <td>80.4%</td>
                      <td><span class="badge bg-success">Tốt</span></td>
                    </tr>
                    <tr>
                      <td>Hôm qua</td>
                      <td>78,000,000 VNĐ</td>
                      <td><span class="text-danger">-5.1%</span></td>
                      <td>78.0%</td>
                      <td><span class="badge bg-warning">Trung bình</span></td>
                    </tr>
                    <tr>
                      <td>2 ngày trước</td>
                      <td>82,150,000 VNĐ</td>
                      <td><span class="text-success">+2.1%</span></td>
                      <td>82.2%</td>
                      <td><span class="badge bg-success">Tốt</span></td>
                    </tr>
                    <tr>
                      <td>3 ngày trước</td>
                      <td>75,300,000 VNĐ</td>
                      <td><span class="text-danger">-6.2%</span></td>
                      <td>75.3%</td>
                      <td><span class="badge bg-warning">Trung bình</span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Performance Metrics -->
      <div class="row mb-4">
        <div class="col-lg-3 mb-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <i class="fas fa-clock fa-2x text-primary mb-2"></i>
              <h6>Giờ cao điểm</h6>
              <h4 class="text-primary">18:00-20:00</h4>
              <small class="text-muted">25,000,000 VNĐ</small>
            </div>
          </div>
        </div>
        <div class="col-lg-3 mb-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <i class="fas fa-users fa-2x text-success mb-2"></i>
              <h6>Giao dịch</h6>
              <h4 class="text-success">156</h4>
              <small class="text-muted">lượt</small>
            </div>
          </div>
        </div>
        <div class="col-lg-3 mb-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <i class="fas fa-dollar-sign fa-2x text-warning mb-2"></i>
              <h6>Trung bình/GD</h6>
              <h4 class="text-warning">515,607</h4>
              <small class="text-muted">VNĐ</small>
            </div>
          </div>
        </div>
        <div class="col-lg-3 mb-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <i class="fas fa-trophy fa-2x text-info mb-2"></i>
              <h6>Xếp hạng</h6>
              <h4 class="text-info">#2</h4>
              <small class="text-muted">trong tuần</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="../assets/js/realtime-clock.js"></script>
    <script>
      // Initialize page with data layer
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Daily Revenue Today Detail page loaded");

        // Initialize data layer
        DataSync.initDataLayer();

        // Get current state and computed data
        const state = SharedState.getState();
        const computedData = Compute.computeAll(state);

        // Render page with computed data
        renderPage(computedData, state);

        // Setup state change listener
        DataSync.onStateChange((newState) => {
          const newComputedData = Compute.computeAll(newState);
          renderPage(newComputedData, newState);
        });
      });

      // Render page with computed data
      function renderPage(data, state) {
        console.log("📊 Rendering page with dynamic revenue calculations...");

        // Check if revenue modules are loaded
        if (
          typeof window.revenueCalc !== "undefined" &&
          typeof window.todayRevenue !== "undefined"
        ) {
          // Use dynamic calculations
          updateRevenueDataDynamic();
        } else {
          // Fallback to computed data from shared layer
          console.warn(
            "⚠️ Revenue modules not loaded, using shared data layer"
          );
          updateRevenueData(data.revenue.stats);
        }

        // Create charts
        createCharts(data);

        // Update page title with time range
        updatePageTitle(state);
      }

      // Update revenue data with dynamic calculations
      function updateRevenueDataDynamic() {
        try {
          console.log("💰 Calculating daily revenue metrics...");

          const today = new Date();
          const todayRevenue = window.todayRevenue || [];
          const yesterdayRevenue = window.yesterdayRevenue || [];

          // Calculate today's revenue
          const todayTotal = window.revenueCalc.calculateDailyRevenue(
            todayRevenue,
            today
          );

          // Calculate yesterday's revenue
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayTotal = window.revenueCalc.calculateDailyRevenue(
            yesterdayRevenue,
            yesterday
          );

          // Calculate growth rate
          const growthRate = window.revenueCalc.calculateRevenueGrowth(
            todayTotal,
            yesterdayTotal
          );

          // Calculate daily target (monthly target / days in month)
          const monthlyTarget = 3000000000; // 3 billion VND
          const daysInMonth = new Date(
            today.getFullYear(),
            today.getMonth() + 1,
            0
          ).getDate();
          const dailyTarget = monthlyTarget / daysInMonth;

          // Calculate completion rate
          const completionRate = (todayTotal / dailyTarget) * 100;

          // Update UI
          updateElement(
            "todayRevenue",
            window.revenueCalc.formatCurrency(todayTotal)
          );

          const growthSign = growthRate >= 0 ? "+" : "";
          updateElement("growthRate", `${growthSign}${growthRate.toFixed(1)}%`);

          updateElement(
            "dailyTarget",
            window.revenueCalc.formatCurrency(dailyTarget)
          );
          updateElement("completionRate", `${completionRate.toFixed(1)}%`);

          console.log("✅ Daily revenue metrics updated:");
          console.log(
            `   💰 Today: ${window.revenueCalc.formatCurrency(todayTotal)} VNĐ`
          );
          console.log(`   📈 Growth: ${growthSign}${growthRate.toFixed(1)}%`);
          console.log(
            `   🎯 Target: ${window.revenueCalc.formatCurrency(
              dailyTarget
            )} VNĐ`
          );
          console.log(`   ✅ Completion: ${completionRate.toFixed(1)}%`);
        } catch (error) {
          console.error("❌ Error calculating daily revenue:", error);
        }
      }

      // Update revenue data (fallback)
      function updateRevenueData(stats) {
        // Update today's revenue
        const todayElement = document.getElementById("todayRevenue");
        if (todayElement) {
          todayElement.textContent = stats.totalRevenue.toLocaleString();
        }

        // Update other metrics as needed
        console.log("Updated revenue data with stats:", stats);
      }

      // Helper function to update element
      function updateElement(id, value) {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        } else {
          console.warn(`Element ${id} not found`);
        }
      }

      // Update page title with time range
      function updatePageTitle(state) {
        const titleElement = document.querySelector("h2.card-title");
        if (titleElement) {
          const timeLabel = TimeUtils.getTimeKeyLabel(state.timeKey);
          titleElement.innerHTML = `<i class="fas fa-calendar-day me-2 text-primary"></i>Chi tiết Doanh thu ${timeLabel}`;
        }
      }

      // Create charts
      function createCharts(data) {
        // Wait for Chart.js to be fully loaded
        if (typeof Chart === "undefined") {
          console.log("Chart.js not loaded yet, retrying...");
          setTimeout(() => createCharts(data), 100);
          return;
        }

        // Service Revenue Chart
        const serviceCtx = document.getElementById("serviceRevenueChart");
        if (serviceCtx) {
          new Chart(serviceCtx, {
            type: "doughnut",
            data: {
              labels: ["Membership", "PT Fitness", "Pilates", "Swimming Coach"],
              datasets: [
                {
                  data: [32000000, 25000000, 15000000, 8443478],
                  backgroundColor: ["#17a2b8", "#dc3545", "#ffc107", "#6f42c1"],
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                },
              },
            },
          });
        }

        // Location Revenue Chart
        const locationCtx = document.getElementById("locationRevenueChart");
        if (locationCtx) {
          new Chart(locationCtx, {
            type: "bar",
            data: {
              labels: [
                "Tôn Thất Thuyết",
                "Huỳnh Thúc Kháng",
                "Giảng Võ",
                "Hào Nam",
                "Nguyễn Tuân",
              ],
              datasets: [
                {
                  label: "Doanh thu (VNĐ)",
                  data: [25000000, 20000000, 18000000, 12000000, 5443478],
                  backgroundColor: [
                    "rgba(23, 162, 184, 0.8)",
                    "rgba(40, 167, 69, 0.8)",
                    "rgba(255, 193, 7, 0.8)",
                    "rgba(220, 53, 69, 0.8)",
                    "rgba(111, 66, 193, 0.8)",
                  ],
                  borderColor: [
                    "#17a2b8",
                    "#28a745",
                    "#ffc107",
                    "#dc3545",
                    "#6f42c1",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return value.toLocaleString() + " VNĐ";
                    },
                  },
                },
              },
            },
          });
        }

        // Hourly Revenue Chart
        const hourlyCtx = document.getElementById("hourlyRevenueChart");
        if (hourlyCtx) {
          new Chart(hourlyCtx, {
            type: "line",
            data: {
              labels: [
                "6:00",
                "7:00",
                "8:00",
                "9:00",
                "10:00",
                "11:00",
                "12:00",
                "13:00",
                "14:00",
                "15:00",
                "16:00",
                "17:00",
                "18:00",
                "19:00",
                "20:00",
                "21:00",
                "22:00",
              ],
              datasets: [
                {
                  label: "Doanh thu hôm nay",
                  data: [
                    2000000, 3000000, 5000000, 4000000, 3500000, 6000000,
                    8000000, 7000000, 4500000, 5500000, 4000000, 3500000,
                    12000000, 13000000, 8000000, 3000000, 1000000,
                  ],
                  borderColor: "#007bff",
                  backgroundColor: "rgba(0, 123, 255, 0.1)",
                  tension: 0.4,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return (value / 1000000).toFixed(1) + "M VNĐ";
                    },
                  },
                },
              },
              plugins: {
                legend: {
                  display: false,
                },
              },
            },
          });
        }
      }
    </script>

    <!-- Universal Page Initializer -->
    <script src="../assets/js/shared/page-initializer.js"></script>
  </body>
</html>

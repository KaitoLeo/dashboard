<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phân tích tần suất Check-in - Actiwell Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="../assets/css/style.css" rel="stylesheet" />
    <style>
      /* Simple and clean table styles */
      .table th {
        font-weight: 600;
        font-size: 14px;
        padding: 12px 8px;
        border-bottom: 2px solid #dee2e6;
      }

      .table td {
        padding: 12px 8px;
        vertical-align: middle;
        font-size: 14px;
      }

      .table tbody tr:hover {
        background-color: #f8f9fa;
      }

      .table-responsive {
        border-radius: 0.375rem;
      }

      .card-header {
        font-size: 16px;
        font-weight: 600;
      }

      .btn-sm {
        font-size: 12px;
        padding: 0.375rem 0.75rem;
      }

      /* Professional clickable elements */
      .clickable-location,
      .clickable-department {
        position: relative;
        overflow: hidden;
      }

      .clickable-location::before,
      .clickable-department::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(13, 110, 253, 0.1),
          transparent
        );
        transition: left 0.5s;
      }

      .clickable-location:hover::before,
      .clickable-department:hover::before {
        left: 100%;
      }

      .clickable-location:active,
      .clickable-department:active {
        transform: translateY(0) scale(0.98);
      }

      /* Card header hover effects */
      .card-header[style*="cursor: pointer"]:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        transition: all 0.2s ease;
      }
    </style>
  
    <!-- Checkin Calculation Modules -->
    <script src="../assets/js/checkin/checkin-calculations.js"></script>
    <script src="../assets/js/checkin/checkin-mock-data.js"></script>
    <script src="../assets/js/api/api-client.js"></script>
    <script src="../assets/js/api/api-services.js"></script>
    <script src="../assets/js/api/data-adapter.js"></script>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-info">
      <div class="container-fluid">
        <a class="navbar-brand" href="../index.html">
          <i class="fas fa-chart-line me-2"></i>Actiwell Dashboard
        </a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="checkin-overview.html">
            <i class="fas fa-arrow-left me-1"></i>Quay lại
          </a>
        </div>
        <div class="navbar-nav">
          <span class="navbar-text text-white">
            <i class="fas fa-clock me-1"></i>
            <span id="currentTime"></span> |
            <span id="currentDate"></span>
          </span>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex align-items-center">
            <i class="fas fa-chart-line text-info fs-3 me-3"></i>
            <div>
              <h2 class="text-info mb-0">Phân tích tần suất Check-in</h2>
              <p class="text-muted mb-0">
                Thống kê chi tiết tần suất check-in của hội viên theo cơ sở và
                bộ phận
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="row mb-4">
        <div class="col-lg-4 col-md-6 mb-3">
          <div class="card bg-primary text-white">
            <div class="card-body text-center">
              <i class="fas fa-users fa-2x text-white mb-2"></i>
              <h6 class="text-white">Tổng hội viên</h6>
              <h4 class="text-white" id="totalMembers">1,250</h4>
              <small class="text-white-50">đang hoạt động</small>
            </div>
          </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-3">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <i class="fas fa-chart-line fa-2x text-white mb-2"></i>
              <h6 class="text-white">Tần suất trung bình</h6>
              <h4 class="text-white" id="avgFrequency">3.2</h4>
              <small class="text-white-50">lần/tuần</small>
            </div>
          </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-3">
          <div class="card bg-warning text-dark">
            <div class="card-body text-center">
              <i class="fas fa-star fa-2x text-dark mb-2"></i>
              <h6 class="text-dark">Hội viên tích cực</h6>
              <h4 class="text-dark" id="activeMembers">456</h4>
              <small class="text-dark">>4 lần/tuần</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="fas fa-filter me-2"></i>Bộ lọc theo tháng
              </h6>
            </div>
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-3 mb-3 mb-md-0">
                  <label for="monthFilter" class="form-label fw-bold"
                    >Chọn tháng:</label
                  >
                  <select
                    class="form-select"
                    id="monthFilter"
                    onchange="filterByMonth()"
                  >
                    <option value="2024-01">Tháng 1/2024</option>
                    <option value="2024-02">Tháng 2/2024</option>
                    <option value="2024-03">Tháng 3/2024</option>
                    <option value="2024-04">Tháng 4/2024</option>
                    <option value="2024-05">Tháng 5/2024</option>
                    <option value="2024-06">Tháng 6/2024</option>
                    <option value="2024-07">Tháng 7/2024</option>
                    <option value="2024-08">Tháng 8/2024</option>
                    <option value="2024-09">Tháng 9/2024</option>
                    <option value="2024-10">Tháng 10/2024</option>
                    <option value="2024-11">Tháng 11/2024</option>
                    <option value="2024-12" selected>Tháng 12/2024</option>
                  </select>
                </div>
                <div class="col-md-3 mb-3 mb-md-0">
                  <label for="yearFilter" class="form-label fw-bold"
                    >Chọn năm:</label
                  >
                  <select
                    class="form-select"
                    id="yearFilter"
                    onchange="filterByMonth()"
                  >
                    <option value="2023">2023</option>
                    <option value="2024" selected>2024</option>
                    <option value="2025">2025</option>
                  </select>
                </div>
                <div class="col-md-3 mb-3 mb-md-0">
                  <button
                    class="btn btn-outline-primary"
                    onclick="resetFilter()"
                  >
                    <i class="fas fa-undo me-1"></i>Đặt lại
                  </button>
                </div>
                <div class="col-md-3">
                  <div class="text-muted">
                    <small>
                      <i class="fas fa-info-circle me-1"></i>
                      Hiển thị dữ liệu cho:
                      <span id="selectedPeriod" class="fw-bold"
                        >Tháng 12/2024</span
                      >
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Frequency Analysis Tables - 2x2 Grid -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 text-primary">
              <i class="fas fa-chart-bar me-2"></i>PHÂN TÍCH TẦN SUẤT CHECK IN
              CỦA HỘI VIÊN
            </h5>
            <button
              class="btn btn-outline-primary btn-sm"
              onclick="refreshData()"
            >
              <i class="fas fa-sync-alt me-1"></i>Làm mới
            </button>
          </div>
        </div>
      </div>

      <!-- First Row: Tôn Thất Thuyết & Huỳnh Thúc Kháng -->
      <div class="row mb-4">
        <div class="col-lg-6 mb-3">
          <div class="card">
            <div
              class="card-header bg-info text-white"
              style="cursor: pointer"
              onclick="showLocationMembersFromCard('ton-that-thuyet')"
              title="Click để xem danh sách hội viên"
            >
              <h6 class="mb-0">
                <i class="fas fa-building me-2"></i>Tôn Thất Thuyết
              </h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table
                  class="table table-bordered table-striped mb-0"
                  id="frequencyTable1"
                >
                  <thead class="table-light">
                    <tr>
                      <th style="width: 20%; text-align: center">Bộ phận</th>
                      <th style="width: 20%; text-align: center">
                        Không hoạt động
                      </th>
                      <th style="width: 20%; text-align: center">
                        1-2 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">
                        3-5 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">&gt;5 lần</th>
                    </tr>
                  </thead>
                  <tbody id="frequencyTableBody1">
                    <!-- Data will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-3">
          <div class="card">
            <div
              class="card-header bg-success text-white"
              style="cursor: pointer"
              onclick="showLocationMembersFromCard('huynh-thuc-khang')"
              title="Click để xem danh sách hội viên"
            >
              <h6 class="mb-0">
                <i class="fas fa-building me-2"></i>Huỳnh Thúc Kháng
              </h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table
                  class="table table-bordered table-striped mb-0"
                  id="frequencyTable2"
                >
                  <thead class="table-light">
                    <tr>
                      <th style="width: 20%; text-align: center">Bộ phận</th>
                      <th style="width: 20%; text-align: center">
                        Không hoạt động
                      </th>
                      <th style="width: 20%; text-align: center">
                        1-2 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">
                        3-5 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">&gt;5 lần</th>
                    </tr>
                  </thead>
                  <tbody id="frequencyTableBody2">
                    <!-- Data will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Second Row: Giảng Võ & Hào Nam -->
      <div class="row mb-4">
        <div class="col-lg-6 mb-3">
          <div class="card">
            <div
              class="card-header bg-warning text-dark"
              style="cursor: pointer"
              onclick="showLocationMembersFromCard('giang-vo')"
              title="Click để xem danh sách hội viên"
            >
              <h6 class="mb-0"><i class="fas fa-building me-2"></i>Giảng Võ</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table
                  class="table table-bordered table-striped mb-0"
                  id="frequencyTable3"
                >
                  <thead class="table-light">
                    <tr>
                      <th style="width: 20%; text-align: center">Bộ phận</th>
                      <th style="width: 20%; text-align: center">
                        Không hoạt động
                      </th>
                      <th style="width: 20%; text-align: center">
                        1-2 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">
                        3-5 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">&gt;5 lần</th>
                    </tr>
                  </thead>
                  <tbody id="frequencyTableBody3">
                    <!-- Data will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-3">
          <div class="card">
            <div
              class="card-header bg-danger text-white"
              style="cursor: pointer"
              onclick="showLocationMembersFromCard('hao-nam')"
              title="Click để xem danh sách hội viên"
            >
              <h6 class="mb-0"><i class="fas fa-building me-2"></i>Hào Nam</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table
                  class="table table-bordered table-striped mb-0"
                  id="frequencyTable4"
                >
                  <thead class="table-light">
                    <tr>
                      <th style="width: 20%; text-align: center">Bộ phận</th>
                      <th style="width: 20%; text-align: center">
                        Không hoạt động
                      </th>
                      <th style="width: 20%; text-align: center">
                        1-2 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">
                        3-5 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">&gt;5 lần</th>
                    </tr>
                  </thead>
                  <tbody id="frequencyTableBody4">
                    <!-- Data will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Third Row: Nguyễn Tuân & Summary Table -->
      <div class="row mb-4">
        <div class="col-lg-6 mb-3">
          <div class="card">
            <div
              class="card-header bg-secondary text-white"
              style="cursor: pointer"
              onclick="showLocationMembersFromCard('nguyen-tuan')"
              title="Click để xem danh sách hội viên"
            >
              <h6 class="mb-0">
                <i class="fas fa-building me-2"></i>Nguyễn Tuân
              </h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table
                  class="table table-bordered table-striped mb-0"
                  id="frequencyTable5"
                >
                  <thead class="table-light">
                    <tr>
                      <th style="width: 20%; text-align: center">Bộ phận</th>
                      <th style="width: 20%; text-align: center">
                        Không hoạt động
                      </th>
                      <th style="width: 20%; text-align: center">
                        1-2 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">
                        3-5 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">&gt;5 lần</th>
                    </tr>
                  </thead>
                  <tbody id="frequencyTableBody5">
                    <!-- Data will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-3">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h6 class="mb-0">
                <i class="fas fa-calculator me-2"></i>TỔNG CỘNG TẤT CẢ CƠ SỞ
              </h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table
                  class="table table-bordered table-striped mb-0"
                  id="summaryTable"
                >
                  <thead class="table-light">
                    <tr>
                      <th style="width: 20%; text-align: center">Bộ phận</th>
                      <th style="width: 20%; text-align: center">
                        Không hoạt động
                      </th>
                      <th style="width: 20%; text-align: center">
                        1-2 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">
                        3-5 lần/tuần
                      </th>
                      <th style="width: 20%; text-align: center">&gt;5 lần</th>
                    </tr>
                  </thead>
                  <tbody id="summaryTableBody">
                    <!-- Data will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="row mt-4">
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-chart-pie me-2"></i>Phân bổ theo tần suất
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="frequencyDistributionChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>So sánh theo cơ sở
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="locationComparisonChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for showing member list -->
    <div
      class="modal fade"
      id="memberListModal"
      tabindex="-1"
      aria-labelledby="memberListModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="memberListModalLabel">
              <i class="fas fa-users me-2"></i>Danh sách hội viên
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="fas fa-search"></i
                  ></span>
                  <input
                    type="text"
                    class="form-control"
                    id="memberSearchInput"
                    placeholder="Tìm kiếm hội viên..."
                  />
                </div>
              </div>
              <div class="col-md-6">
                <select class="form-select" id="frequencyFilter">
                  <option value="all">Tất cả tần suất</option>
                  <option value="inactive">Không hoạt động</option>
                  <option value="low">1-2 lần/tuần</option>
                  <option value="medium">3-5 lần/tuần</option>
                  <option value="high">>5 lần</option>
                </select>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover" id="memberListTable">
                <thead class="table-dark">
                  <tr>
                    <th>STT</th>
                    <th>Hội viên</th>
                    <th>Bộ phận</th>
                    <th>Tần suất check-in</th>
                    <th>Số lần/tuần</th>
                    <th>Lần check-in gần nhất</th>
                    <th>Trạng thái</th>
                  </tr>
                </thead>
                <tbody id="memberListTableBody">
                  <!-- Data will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
      // Seeded Random Number Generator for Consistent Data
      class SeededRandom {
        constructor(seed = 12345) {
          this.seed = seed;
        }

        next() {
          this.seed = (this.seed * 9301 + 49297) % 233280;
          return this.seed / 233280;
        }

        nextInt(min, max) {
          return Math.floor(this.next() * (max - min + 1)) + min;
        }

        nextFloat(min, max, decimals = 2) {
          return parseFloat(
            (this.next() * (max - min) + min).toFixed(decimals)
          );
        }

        choice(array) {
          return array[this.nextInt(0, array.length - 1)];
        }
      }

      // Initialize seeded random generator
      const rng = new SeededRandom(12345);

      // Function to generate sample member data for a location
      function generateMemberDataForLocation(
        locationKey,
        locationName,
        baseId
      ) {
        const departments = ["membership", "pt", "pilates", "swimming-coach"];
        const deptNames = [
          "Membership",
          "PT Fitness",
          "Pilates",
          "Swimming Coach",
        ];
        const locationData = {};

        departments.forEach((dept, deptIndex) => {
          const deptName = deptNames[deptIndex];
          locationData[dept] = {
            inactive: [],
            low: [],
            medium: [],
            high: [],
          };

          // Generate inactive members (0-2 members per department)
          const inactiveCount = Math.floor(rng.next() * 3);
          for (let i = 0; i < inactiveCount; i++) {
            locationData[dept].inactive.push({
              id: baseId + i,
              name: `${deptName} Inactive ${i + 1}`,
              frequency: "inactive",
              timesPerWeek: 0,
              lastCheckin: "2024-01-" + (5 + i),
              status: "inactive",
              department: dept,
            });
          }

          // Generate low frequency members (1-3 members per department)
          const lowCount = Math.floor(rng.next() * 3) + 1;
          for (let i = 0; i < lowCount; i++) {
            locationData[dept].low.push({
              id: baseId + inactiveCount + i,
              name: `${deptName} Low ${i + 1}`,
              frequency: "low",
              timesPerWeek: Math.floor(rng.next() * 2) + 1,
              lastCheckin: "2024-01-15",
              status: "active",
              department: dept,
            });
          }

          // Generate medium frequency members (1-3 members per department)
          const mediumCount = Math.floor(rng.next() * 3) + 1;
          for (let i = 0; i < mediumCount; i++) {
            locationData[dept].medium.push({
              id: baseId + inactiveCount + lowCount + i,
              name: `${deptName} Medium ${i + 1}`,
              frequency: "medium",
              timesPerWeek: Math.floor(rng.next() * 2) + 3,
              lastCheckin: "2024-01-16",
              status: "active",
              department: dept,
            });
          }

          // Generate high frequency members (0-2 members per department)
          const highCount = Math.floor(rng.next() * 3);
          for (let i = 0; i < highCount; i++) {
            locationData[dept].high.push({
              id: baseId + inactiveCount + lowCount + mediumCount + i,
              name: `${deptName} High ${i + 1}`,
              frequency: "high",
              timesPerWeek: Math.floor(rng.next() * 3) + 6,
              lastCheckin: "2024-01-16",
              status: "active",
              department: dept,
            });
          }
        });

        return locationData;
      }

      // Sample member data - Generated dynamically
      const memberData = {
        "ton-that-thuyet": generateMemberDataForLocation(
          "ton-that-thuyet",
          "Tôn Thất Thuyết",
          1
        ),
        "huynh-thuc-khang": generateMemberDataForLocation(
          "huynh-thuc-khang",
          "Huỳnh Thúc Kháng",
          100
        ),
        "giang-vo": generateMemberDataForLocation("giang-vo", "Giảng Võ", 200),
        "hao-nam": generateMemberDataForLocation("hao-nam", "Hào Nam", 300),
        "nguyen-tuan": generateMemberDataForLocation(
          "nguyen-tuan",
          "Nguyễn Tuân",
          400
        ),
      };

      // Sample data for frequency analysis
      const frequencyData = {
        "ton-that-thuyet": {
          name: "Tôn Thất Thuyết",
          membership: { inactive: 15, low: 35, medium: 28, high: 15 },
          pt: { inactive: 12, low: 25, medium: 18, high: 8 },
          pilates: { inactive: 8, low: 12, medium: 12, high: 3 },
          "swimming-coach": { inactive: 5, low: 10, medium: 8, high: 2 },
        },
        "huynh-thuc-khang": {
          name: "Huỳnh Thúc Kháng",
          membership: { inactive: 20, low: 45, medium: 35, high: 18 },
          pt: { inactive: 15, low: 30, medium: 22, high: 12 },
          pilates: { inactive: 10, low: 15, medium: 15, high: 5 },
          "swimming-coach": { inactive: 8, low: 12, medium: 10, high: 4 },
        },
        "giang-vo": {
          name: "Giảng Võ",
          membership: { inactive: 12, low: 25, medium: 18, high: 8 },
          pt: { inactive: 8, low: 18, medium: 12, high: 5 },
          pilates: { inactive: 5, low: 8, medium: 8, high: 2 },
          "swimming-coach": { inactive: 3, low: 6, medium: 5, high: 1 },
        },
        "hao-nam": {
          name: "Hào Nam",
          membership: { inactive: 15, low: 30, medium: 22, high: 10 },
          pt: { inactive: 10, low: 22, medium: 15, high: 6 },
          pilates: { inactive: 6, low: 10, medium: 10, high: 3 },
          "swimming-coach": { inactive: 4, low: 8, medium: 6, high: 2 },
        },
        "nguyen-tuan": {
          name: "Nguyễn Tuân",
          membership: { inactive: 10, low: 20, medium: 15, high: 6 },
          pt: { inactive: 6, low: 15, medium: 10, high: 4 },
          pilates: { inactive: 3, low: 6, medium: 6, high: 2 },
          "swimming-coach": { inactive: 2, low: 4, medium: 4, high: 1 },
        },
      };

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded, initializing page...");
        updateDateTime();
        loadFrequencyData();
        createCharts();
        setInterval(updateDateTime, 1000);
      });

      // Also try to load data immediately if DOM is already loaded
      if (document.readyState === "loading") {
        console.log("Document still loading...");
      } else {
        console.log("Document already loaded, loading data immediately...");
        updateDateTime();
        loadFrequencyData();
        createCharts();
        setInterval(updateDateTime, 1000);
      }

      function updateDateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString("vi-VN");
        const dateString = now.toLocaleDateString("vi-VN");

        const timeElement = document.getElementById("currentTime");
        const dateElement = document.getElementById("currentDate");

        if (timeElement) timeElement.textContent = timeString;
        if (dateElement) dateElement.textContent = dateString;
      }

      function loadFrequencyData() {
        console.log("Loading frequency data...");

        // Define location order and their corresponding table IDs
        const locationOrder = [
          {
            key: "ton-that-thuyet",
            name: "Tôn Thất Thuyết",
            tableId: "frequencyTableBody1",
          },
          {
            key: "huynh-thuc-khang",
            name: "Huỳnh Thúc Kháng",
            tableId: "frequencyTableBody2",
          },
          { key: "giang-vo", name: "Giảng Võ", tableId: "frequencyTableBody3" },
          { key: "hao-nam", name: "Hào Nam", tableId: "frequencyTableBody4" },
          {
            key: "nguyen-tuan",
            name: "Nguyễn Tuân",
            tableId: "frequencyTableBody5",
          },
        ];

        let totalInactive = 0;
        let totalLow = 0;
        let totalMedium = 0;
        let totalHigh = 0;

        // Load data for each location table
        locationOrder.forEach((locationInfo, locationIndex) => {
          const tbody = document.getElementById(locationInfo.tableId);
          if (!tbody) {
            console.error(`Table body ${locationInfo.tableId} not found!`);
            return;
          }
          tbody.innerHTML = "";

          const location = frequencyData[locationInfo.key];
          if (!location) {
            console.error(`Location data for ${locationInfo.key} not found!`);
            return;
          }

          const departments = ["membership", "pt", "pilates", "swimming-coach"];

          departments.forEach((dept) => {
            const row = document.createElement("tr");
            const deptName = getDepartmentDisplayName(dept);
            const data = location[dept];

            // Cộng dồn vào tổng
            totalInactive += data.inactive;
            totalLow += data.low;
            totalMedium += data.medium;
            totalHigh += data.high;

            // Tạo HTML cho từng dòng
            const rowHTML = `
              <td style="vertical-align: middle; font-weight: 500;">
              <span class="clickable-department" style="cursor: pointer; color: #6c757d; padding: 3px 6px; border-radius: 3px; transition: all 0.2s ease; display: inline-block;" 
                    onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.color='#0d6efd'; this.style.transform='translateY(-1px)'" 
                    onmouseout="this.style.backgroundColor='transparent'; this.style.color='#6c757d'; this.style.transform='translateY(0)'"
                      onclick="showDepartmentMembers('${locationInfo.key}', '${dept}')" 
                    title="Click để xem danh sách hội viên">
                <i class="fas fa-users me-1"></i>${deptName}
              </span>
              </td>
              <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #6c757d;">${data.inactive}</td>
              <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #ffc107;">${data.low}</td>
              <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #198754;">${data.medium}</td>
              <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #0d6efd;">${data.high}</td>
            `;

            row.innerHTML = rowHTML;
            tbody.appendChild(row);
          });
        });

        // Load summary table
        const summaryTbody = document.getElementById("summaryTableBody");
        if (summaryTbody) {
          summaryTbody.innerHTML = "";

          const departments = ["membership", "pt", "pilates", "swimming-coach"];
          let deptInactive = 0,
            deptLow = 0,
            deptMedium = 0,
            deptHigh = 0;

          departments.forEach((dept) => {
            const row = document.createElement("tr");
            const deptName = getDepartmentDisplayName(dept);

            // Calculate totals for this department across all locations
            deptInactive = 0;
            deptLow = 0;
            deptMedium = 0;
            deptHigh = 0;

            Object.keys(frequencyData).forEach((locationKey) => {
              const location = frequencyData[locationKey];
              if (location && location[dept]) {
                deptInactive += location[dept].inactive;
                deptLow += location[dept].low;
                deptMedium += location[dept].medium;
                deptHigh += location[dept].high;
              }
            });

            const rowHTML = `
              <td style="vertical-align: middle; font-weight: 500;">
                <i class="fas fa-users me-1"></i>${deptName}
              </td>
              <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #6c757d;">${deptInactive}</td>
              <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #ffc107;">${deptLow}</td>
              <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #198754;">${deptMedium}</td>
              <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #0d6efd;">${deptHigh}</td>
            `;

            row.innerHTML = rowHTML;
            summaryTbody.appendChild(row);
          });

          // Add total row
          const totalRow = document.createElement("tr");
          totalRow.style.backgroundColor = "#e9ecef";
          totalRow.style.fontWeight = "bold";

          const totalRowHTML = `
            <td style="text-align: center; vertical-align: middle; font-weight: bold; background-color: #dee2e6; border-top: 2px solid #6c757d;">
              <i class="fas fa-calculator me-2"></i>TỔNG CỘNG
            </td>
            <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #6c757d; background-color: #dee2e6; border-top: 2px solid #6c757d; font-size: 1.1em;">${totalInactive}</td>
            <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #ffc107; background-color: #dee2e6; border-top: 2px solid #6c757d; font-size: 1.1em;">${totalLow}</td>
            <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #198754; background-color: #dee2e6; border-top: 2px solid #6c757d; font-size: 1.1em;">${totalMedium}</td>
            <td style="text-align: center; vertical-align: middle; font-weight: bold; color: #0d6efd; background-color: #dee2e6; border-top: 2px solid #6c757d; font-size: 1.1em;">${totalHigh}</td>
          `;

          totalRow.innerHTML = totalRowHTML;
          summaryTbody.appendChild(totalRow);
        }

        console.log("Frequency data loaded successfully!");
      }

      function getDepartmentIcon(dept) {
        const icons = {
          membership: "fas fa-id-card",
          pt: "fas fa-dumbbell",
          pilates: "fas fa-leaf",
          "swimming-coach": "fas fa-swimmer",
        };
        return icons[dept] || "fas fa-users";
      }

      function getDepartmentColor(dept) {
        const colors = {
          membership: "text-primary",
          pt: "text-warning",
          pilates: "text-pink",
          "swimming-coach": "text-info",
        };
        return colors[dept] || "text-secondary";
      }

      function getDepartmentDisplayName(dept) {
        const names = {
          membership: "Membership",
          pt: "PT Fitness",
          pilates: "Pilates",
          "swimming-coach": "Swimming Coach",
        };
        return names[dept] || dept;
      }

      function createCharts() {
        // Calculate totals from frequencyData
        let totalInactive = 0;
        let totalLow = 0;
        let totalMedium = 0;
        let totalHigh = 0;

        const locationLabels = [];
        const inactiveData = [];
        const lowData = [];
        const mediumData = [];
        const highData = [];

        Object.keys(frequencyData).forEach((locationKey) => {
          const location = frequencyData[locationKey];
          const departments = ["membership", "pt", "pilates", "swimming-coach"];

          let locationInactive = 0;
          let locationLow = 0;
          let locationMedium = 0;
          let locationHigh = 0;

          departments.forEach((dept) => {
            const data = location[dept];
            locationInactive += data.inactive;
            locationLow += data.low;
            locationMedium += data.medium;
            locationHigh += data.high;
          });

          totalInactive += locationInactive;
          totalLow += locationLow;
          totalMedium += locationMedium;
          totalHigh += locationHigh;

          locationLabels.push(location.name);
          inactiveData.push(locationInactive);
          lowData.push(locationLow);
          mediumData.push(locationMedium);
          highData.push(locationHigh);
        });

        // Frequency Distribution Chart
        const frequencyCtx = document
          .getElementById("frequencyDistributionChart")
          .getContext("2d");
        new Chart(frequencyCtx, {
          type: "doughnut",
          data: {
            labels: [
              "Không hoạt động",
              "1-2 lần/tuần",
              "3-5 lần/tuần",
              ">5 lần",
            ],
            datasets: [
              {
                data: [totalInactive, totalLow, totalMedium, totalHigh],
                backgroundColor: ["#6c757d", "#ffc107", "#198754", "#0d6efd"],
                borderWidth: 2,
                borderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  usePointStyle: true,
                  padding: 20,
                  font: {
                    size: 12,
                  },
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0
                    );
                    const percentage = ((context.parsed / total) * 100).toFixed(
                      1
                    );
                    return `${context.label}: ${context.parsed} hội viên (${percentage}%)`;
                  },
                },
              },
            },
          },
        });

        // Location Comparison Chart
        const locationCtx = document
          .getElementById("locationComparisonChart")
          .getContext("2d");
        new Chart(locationCtx, {
          type: "bar",
          data: {
            labels: locationLabels,
            datasets: [
              {
                label: "Không hoạt động",
                data: inactiveData,
                backgroundColor: "#6c757d",
              },
              {
                label: "1-2 lần/tuần",
                data: lowData,
                backgroundColor: "#ffc107",
              },
              {
                label: "3-5 lần/tuần",
                data: mediumData,
                backgroundColor: "#198754",
              },
              {
                label: ">5 lần",
                data: highData,
                backgroundColor: "#0d6efd",
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                stacked: true,
              },
              y: {
                stacked: true,
                beginAtZero: true,
              },
            },
            plugins: {
              legend: {
                position: "top",
              },
            },
          },
        });
      }

      function refreshData() {
        loadFrequencyData();
        createCharts();
        console.log("Data refreshed");
      }

      // Function to show members by location
      function showLocationMembers(locationKey) {
        const location = frequencyData[locationKey];
        if (!location) return;

        const modal = new bootstrap.Modal(
          document.getElementById("memberListModal")
        );
        document.getElementById(
          "memberListModalLabel"
        ).innerHTML = `<i class="fas fa-users me-2"></i>Danh sách hội viên - ${location.name}`;

        // Get all members from all departments in this location
        let allMembers = [];
        const departments = ["membership", "pt", "pilates", "swimming-coach"];

        departments.forEach((dept) => {
          if (memberData[locationKey] && memberData[locationKey][dept]) {
            // Updated frequency keys to match new structure
            const frequencies = ["inactive", "low", "medium", "high"];
            frequencies.forEach((frequency) => {
              if (memberData[locationKey][dept][frequency]) {
                allMembers = allMembers.concat(
                  memberData[locationKey][dept][frequency]
                );
              }
            });
          }
        });

        displayMemberList(allMembers);
        modal.show();
      }

      // Function to show members by location (for card headers)
      function showLocationMembersFromCard(locationKey) {
        showLocationMembers(locationKey);
      }

      // Function to show members by department
      function showDepartmentMembers(locationKey, department) {
        const location = frequencyData[locationKey];
        const deptName = getDepartmentDisplayName(department);
        if (!location) return;

        const modal = new bootstrap.Modal(
          document.getElementById("memberListModal")
        );
        document.getElementById(
          "memberListModalLabel"
        ).innerHTML = `<i class="fas fa-users me-2"></i>Danh sách hội viên - ${location.name} - ${deptName}`;

        // Get all members from this specific department
        let allMembers = [];
        if (memberData[locationKey] && memberData[locationKey][department]) {
          // Updated frequency keys to match new structure
          const frequencies = ["inactive", "low", "medium", "high"];
          frequencies.forEach((frequency) => {
            if (memberData[locationKey][department][frequency]) {
              allMembers = allMembers.concat(
                memberData[locationKey][department][frequency]
              );
            }
          });
        }

        displayMemberList(allMembers);
        modal.show();
      }

      // Function to display member list in modal
      function displayMemberList(members) {
        const tbody = document.getElementById("memberListTableBody");
        tbody.innerHTML = "";

        members.forEach((member, index) => {
          const row = document.createElement("tr");
          const frequencyText = getFrequencyText(member.frequency);
          const statusBadge = getStatusBadge(member.status);

          row.innerHTML = `
            <td>${index + 1}</td>
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 12px;">
                  ${member.name.charAt(0)}
                </div>
                <div>
                  <div class="fw-bold">${member.name}</div>
                  <small class="text-muted">ID: ${member.id}</small>
                </div>
              </div>
            </td>
            <td>
              <span class="badge bg-info">${getDepartmentDisplayName(
                member.department || "membership"
              )}</span>
            </td>
            <td>
              <span class="badge ${getFrequencyBadgeClass(
                member.frequency
              )}">${frequencyText}</span>
            </td>
            <td class="text-center fw-bold">${member.timesPerWeek}</td>
            <td>
              <small class="text-muted">${formatDate(
                member.lastCheckin
              )}</small>
            </td>
            <td>${statusBadge}</td>
          `;
          tbody.appendChild(row);
        });

        // Add search and filter functionality
        setupMemberListFilters();
      }

      // Helper functions
      function getFrequencyText(frequency) {
        const texts = {
          inactive: "Không hoạt động",
          low: "1-2 lần/tuần",
          medium: "3-5 lần/tuần",
          high: ">5 lần",
        };
        return texts[frequency] || frequency;
      }

      function getFrequencyBadgeClass(frequency) {
        const classes = {
          inactive: "bg-secondary",
          low: "bg-warning",
          medium: "bg-success",
          high: "bg-primary",
        };
        return classes[frequency] || "bg-secondary";
      }

      function getStatusBadge(status) {
        if (status === "active") {
          return '<span class="badge bg-success">Hoạt động</span>';
        } else {
          return '<span class="badge bg-secondary">Không hoạt động</span>';
        }
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("vi-VN");
      }

      function setupMemberListFilters() {
        const searchInput = document.getElementById("memberSearchInput");
        const frequencyFilter = document.getElementById("frequencyFilter");

        // Clear previous event listeners
        searchInput.oninput = null;
        frequencyFilter.onchange = null;

        // Add new event listeners
        searchInput.oninput = function () {
          filterMemberList();
        };

        frequencyFilter.onchange = function () {
          filterMemberList();
        };
      }

      function filterMemberList() {
        const searchTerm = document
          .getElementById("memberSearchInput")
          .value.toLowerCase();
        const frequencyFilter =
          document.getElementById("frequencyFilter").value;
        const rows = document.querySelectorAll("#memberListTableBody tr");

        rows.forEach((row) => {
          const name = row.cells[1].textContent.toLowerCase();
          const frequency = row.cells[3].textContent;

          const matchesSearch = name.includes(searchTerm);
          const matchesFrequency =
            frequencyFilter === "all" ||
            (frequencyFilter === "inactive" &&
              frequency.includes("Không hoạt động")) ||
            (frequencyFilter === "low" && frequency.includes("1-2")) ||
            (frequencyFilter === "medium" && frequency.includes("3-5")) ||
            (frequencyFilter === "high" && frequency.includes(">5"));

          if (matchesSearch && matchesFrequency) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      // Filter functions
      function filterByMonth() {
        const monthFilter = document.getElementById("monthFilter");
        const yearFilter = document.getElementById("yearFilter");
        const selectedPeriod = document.getElementById("selectedPeriod");

        const selectedMonth = monthFilter.value;
        const selectedYear = yearFilter.value;

        // Update the selected period display
        const monthNames = [
          "Tháng 1",
          "Tháng 2",
          "Tháng 3",
          "Tháng 4",
          "Tháng 5",
          "Tháng 6",
          "Tháng 7",
          "Tháng 8",
          "Tháng 9",
          "Tháng 10",
          "Tháng 11",
          "Tháng 12",
        ];
        const monthNumber = parseInt(selectedMonth.split("-")[1]) - 1;
        selectedPeriod.textContent = `${monthNames[monthNumber]}/${selectedYear}`;

        // Update month filter options based on selected year
        updateMonthOptions(selectedYear);

        // Simulate data filtering (in real app, this would call API)
        console.log(`Filtering data for: ${selectedMonth}`);

        // Reload data with new filter
        loadFrequencyData();
        createCharts();
      }

      function updateMonthOptions(year) {
        const monthFilter = document.getElementById("monthFilter");
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;

        // Clear existing options
        monthFilter.innerHTML = "";

        // Add months for the selected year
        for (let month = 1; month <= 12; month++) {
          const option = document.createElement("option");
          option.value = `${year}-${month.toString().padStart(2, "0")}`;
          option.textContent = `Tháng ${month}/${year}`;

          // Select current month if it's the current year
          if (year == currentYear && month == currentMonth) {
            option.selected = true;
          }

          monthFilter.appendChild(option);
        }
      }

      function resetFilter() {
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;

        // Reset to current month/year
        document.getElementById("yearFilter").value = currentYear;
        updateMonthOptions(currentYear);

        // Update display
        const monthNames = [
          "Tháng 1",
          "Tháng 2",
          "Tháng 3",
          "Tháng 4",
          "Tháng 5",
          "Tháng 6",
          "Tháng 7",
          "Tháng 8",
          "Tháng 9",
          "Tháng 10",
          "Tháng 11",
          "Tháng 12",
        ];
        document.getElementById("selectedPeriod").textContent = `${
          monthNames[currentMonth - 1]
        }/${currentYear}`;

        // Reload data
        loadFrequencyData();
        createCharts();
      }

      // Initialize filter on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Set initial filter values
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;

        document.getElementById("yearFilter").value = currentYear;
        updateMonthOptions(currentYear);
      });
    </script>

    <!-- SPA System -->
    <script src="../assets/js/spa/store.js"></script>
    <script src="../assets/js/spa/components.js"></script>
    <script src="../assets/js/spa/router.js"></script>
    <script src="../assets/js/spa/integration.js"></script>
  
    <!-- Universal Page Initializer -->
    <script src="../assets/js/shared/page-initializer.js"></script>
  </body>
</html>

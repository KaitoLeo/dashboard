<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết Check-in hôm nay - Actiwell Reports</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="../assets/css/style.css" rel="stylesheet" />
    <style>
      .metric-card {
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .clickable-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .clickable-row:hover {
        background-color: #f8f9fa !important;
      }
    </style>
  
    <!-- Checkin Calculation Modules -->
    <script src="../assets/js/checkin/checkin-calculations.js"></script>
    <script src="../assets/js/checkin/checkin-mock-data.js"></script>
    <script src="../assets/js/api/api-client.js"></script>
    <script src="../assets/js/api/api-services.js"></script>
    <script src="../assets/js/api/data-adapter.js"></script>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="../index.html">
          <i class="fas fa-heartbeat me-2"></i>Actiwell Reports
        </a>
        <a class="nav-link text-light" href="auto-daily-report.html">
          <i class="fas fa-arrow-left me-1"></i>Quay lại Báo cáo
        </a>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h1 class="card-title mb-2">
                <i class="fas fa-calendar-check me-2 text-primary"></i>
                Chi tiết Check-in hôm nay
              </h1>
              <p class="text-muted mb-0" id="reportInfo">
                Danh sách khách hàng check-in ngày
                <span id="currentDate"></span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="card bg-primary text-white h-100">
            <div class="card-body text-center">
              <i class="fas fa-users fa-2x mb-2"></i>
              <h3 class="mb-1" id="totalCheckins">245</h3>
              <p class="mb-0">Tổng lượt check-in</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card bg-success text-white h-100">
            <div class="card-body text-center">
              <i class="fas fa-building fa-2x mb-2"></i>
              <h3 class="mb-1" id="totalClubs">5</h3>
              <p class="mb-0">Số cơ sở</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card bg-info text-white h-100">
            <div class="card-body text-center">
              <i class="fas fa-clock fa-2x mb-2"></i>
              <h3 class="mb-1" id="avgTime">08:30</h3>
              <p class="mb-0">Giờ check-in TB</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card bg-warning text-white h-100">
            <div class="card-body text-center">
              <i class="fas fa-chart-line fa-2x mb-2"></i>
              <h3 class="mb-1" id="peakHour">09:00</h3>
              <p class="mb-0">Giờ cao điểm</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Check-in List -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <div class="row align-items-center">
                <div class="col">
                  <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Danh sách Check-in
                  </h5>
                </div>
                <div class="col-auto">
                  <span class="badge bg-primary" id="recordCount">245</span>
                </div>
              </div>
            </div>
            <div class="card-body">
              <!-- Filters -->
              <div class="row mb-3">
                <div class="col-md-3 mb-2">
                  <input
                    type="text"
                    class="form-control"
                    id="searchInput"
                    placeholder="Tìm kiếm..."
                    onkeyup="searchData()"
                  />
                </div>
                <div class="col-md-2 mb-2">
                  <select
                    class="form-select"
                    id="clubFilter"
                    onchange="searchData()"
                  >
                    <option value="all">Tất cả cơ sở</option>
                    <option value="Tôn Thất Thuyết">Tôn Thất Thuyết</option>
                    <option value="Huỳnh Thúc Kháng">Huỳnh Thúc Kháng</option>
                    <option value="Giảng Võ">Giảng Võ</option>
                    <option value="Hào Nam">Hào Nam</option>
                    <option value="Nguyễn Tuân">Nguyễn Tuân</option>
                  </select>
                </div>
                <div class="col-md-2 mb-2">
                  <select
                    class="form-select"
                    id="typeFilter"
                    onchange="searchData()"
                  >
                    <option value="all">Tất cả loại</option>
                    <option value="Hội viên">Hội viên</option>
                    <option value="Khách tập thử">Khách tập thử</option>
                    <option value="Khách tham quan">Khách tham quan</option>
                  </select>
                </div>
                <div class="col-md-2 mb-2">
                  <select
                    class="form-select"
                    id="timeFilter"
                    onchange="searchData()"
                  >
                    <option value="all">Tất cả giờ</option>
                    <option value="morning">Sáng (6h-12h)</option>
                    <option value="afternoon">Chiều (12h-18h)</option>
                    <option value="evening">Tối (18h-22h)</option>
                  </select>
                </div>
                <div class="col-md-2 mb-2">
                  <button
                    class="btn btn-outline-secondary w-100"
                    onclick="resetFilters()"
                  >
                    <i class="fas fa-undo me-1"></i>Reset
                  </button>
                </div>
                <div class="col-md-1 mb-2">
                  <button class="btn btn-success w-100" onclick="exportData()">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>

              <!-- Table -->
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>STT</th>
                      <th>Khách hàng</th>
                      <th>SĐT</th>
                      <th>Giờ check-in</th>
                      <th>Cơ sở</th>
                      <th>Loại</th>
                      <th>Gói tập</th>
                    </tr>
                  </thead>
                  <tbody id="checkinTableBody">
                    <!-- Data will be loaded here -->
                  </tbody>
                </table>
              </div>

              <!-- Pagination -->
              <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center" id="pagination">
                  <!-- Pagination will be generated here -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../assets/js/shared/data-generator.js"></script>
    <script src="../assets/js/shared/dynamic-updater.js"></script>
    <script src="../assets/js/data-consistency.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
      // Dynamic data generation
      let checkinData = [];
      let filteredData = [];
      let currentPage = 1;
      const itemsPerPage = 10;

      // Initialize page with dynamic data
      function initializePage() {
        // Generate dynamic data
        checkinData = DataGenerator.generateCheckinData(245, {
          timeRange: "morning",
          includeLate: true,
          includeEarly: true,
        });

        // Add member types and packages
        checkinData = checkinData.map((item) => ({
          ...item,
          type: DataGenerator.randomChoice([
            "Hội viên",
            "Hội viên",
            "Hội viên",
            "Khách tập thử",
            "Khách tham quan",
          ]),
          package: DataGenerator.randomChoice([
            "Gym 12 tháng",
            "Yoga 6 tháng",
            "Fitness 3 tháng",
            "Trial 1 ngày",
            "Swimming 12 tháng",
            "Pilates 6 tháng",
            "Tham quan",
            "Gym 6 tháng",
          ]),
        }));

        filteredData = [...checkinData];

        // Update metric cards
        updateMetricCards();

        // Load table data
        loadCheckinData();

        // Update date display
        updateDateDisplay();
      }

      // Update metric cards dynamically
      function updateMetricCards() {
        const totalCheckins = checkinData.length;
        const uniqueClubs = new Set(checkinData.map((item) => item.location))
          .size;

        // Calculate average check-in time
        const times = checkinData.map((item) => {
          const [hour, minute] = item.checkinTime.split(":").map(Number);
          return hour * 60 + minute;
        });
        const avgMinutes =
          times.reduce((sum, time) => sum + time, 0) / times.length;
        const avgHour = Math.floor(avgMinutes / 60);
        const avgMinute = Math.floor(avgMinutes % 60);
        const avgTime = `${String(avgHour).padStart(2, "0")}:${String(
          avgMinute
        ).padStart(2, "0")}`;

        // Calculate peak hour
        const hourCounts = {};
        checkinData.forEach((item) => {
          const hour = item.checkinTime.split(":")[0];
          hourCounts[hour] = (hourCounts[hour] || 0) + 1;
        });
        const peakHour = Object.keys(hourCounts).reduce((a, b) =>
          hourCounts[a] > hourCounts[b] ? a : b
        );

        // Update DOM elements
        document.getElementById("totalCheckins").textContent = totalCheckins;
        document.getElementById("totalClubs").textContent = uniqueClubs;
        document.getElementById("avgTime").textContent = avgTime;
        document.getElementById("peakHour").textContent = peakHour + ":00";
      }

      // Load check-in data into table
      function loadCheckinData() {
        const tbody = document.getElementById("checkinTableBody");
        tbody.innerHTML = "";

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = filteredData.slice(startIndex, endIndex);

        pageData.forEach((item, index) => {
          const row = document.createElement("tr");
          row.className = "clickable-row";
          row.innerHTML = `
            <td>${startIndex + index + 1}</td>
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                  ${item.memberName.charAt(0)}
                </div>
                <div>
                  <div class="fw-bold">${item.memberName}</div>
                  <small class="text-muted">ID: ${item.memberId}</small>
                </div>
              </div>
            </td>
            <td>${item.phone}</td>
            <td>${item.checkinTime}</td>
            <td>
              <span class="badge bg-info">${item.location}</span>
            </td>
            <td>
              <span class="badge ${getTypeBadgeClass(item.type)}">${
            item.type
          }</span>
            </td>
            <td>${item.package}</td>
          `;
          tbody.appendChild(row);
        });

        // Update pagination
        updatePagination();
        updateRecordCount();
      }

      // Get badge class for member type
      function getTypeBadgeClass(type) {
        switch (type) {
          case "Hội viên":
            return "bg-success";
          case "Khách tập thử":
            return "bg-warning";
          case "Khách tham quan":
            return "bg-info";
          default:
            return "bg-secondary";
        }
      }

      // Update pagination
      function updatePagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        const totalPages = Math.ceil(filteredData.length / itemsPerPage);

        if (totalPages <= 1) return;

        // Previous button
        const prevLi = document.createElement("li");
        prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${
          currentPage - 1
        })">Trước</a>`;
        pagination.appendChild(prevLi);

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          const li = document.createElement("li");
          li.className = `page-item ${i === currentPage ? "active" : ""}`;
          li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
          pagination.appendChild(li);
        }

        // Next button
        const nextLi = document.createElement("li");
        nextLi.className = `page-item ${
          currentPage === totalPages ? "disabled" : ""
        }`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${
          currentPage + 1
        })">Tiếp</a>`;
        pagination.appendChild(nextLi);
      }

      // Change page
      function changePage(page) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (page < 1 || page > totalPages) return;

        currentPage = page;
        loadCheckinData();
      }

      // Search and filter data
      function searchData() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const clubFilter = document.getElementById("clubFilter").value;
        const typeFilter = document.getElementById("typeFilter").value;
        const timeFilter = document.getElementById("timeFilter").value;

        filteredData = checkinData.filter((item) => {
          const matchesSearch =
            item.memberName.toLowerCase().includes(searchTerm) ||
            item.phone.includes(searchTerm) ||
            item.package.toLowerCase().includes(searchTerm);

          const matchesClub =
            clubFilter === "all" || item.location === clubFilter;
          const matchesType = typeFilter === "all" || item.type === typeFilter;

          let matchesTime = true;
          if (timeFilter !== "all") {
            const hour = parseInt(item.checkinTime.split(":")[0]);
            if (timeFilter === "morning") {
              matchesTime = hour >= 6 && hour < 12;
            } else if (timeFilter === "afternoon") {
              matchesTime = hour >= 12 && hour < 18;
            } else if (timeFilter === "evening") {
              matchesTime = hour >= 18 && hour < 22;
            }
          }

          return matchesSearch && matchesClub && matchesType && matchesTime;
        });

        currentPage = 1;
        loadCheckinData();
      }

      // Reset filters
      function resetFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("clubFilter").value = "all";
        document.getElementById("typeFilter").value = "all";
        document.getElementById("timeFilter").value = "all";

        filteredData = [...checkinData];
        currentPage = 1;
        loadCheckinData();
      }

      // Update record count
      function updateRecordCount() {
        document.getElementById("recordCount").textContent =
          filteredData.length;
      }

      // View details
      function viewDetails(id) {
        const item = checkinData.find((item) => item.id === id);
        if (item) {
          alert(
            `Chi tiết khách hàng:\nTên: ${item.memberName}\nSĐT: ${item.phone}\nGiờ check-in: ${item.checkinTime}\nCơ sở: ${item.location}\nLoại: ${item.type}\nGói tập: ${item.package}`
          );
        }
      }

      // Call customer
      function callCustomer(phone) {
        if (confirm(`Bạn có muốn gọi cho ${phone}?`)) {
          window.open(`tel:${phone}`);
        }
      }

      // Export data
      function exportData() {
        alert("Chức năng xuất Excel sẽ được triển khai!");
      }

      // Update date display
      function updateDateDisplay() {
        const now = new Date();
        const dateString = now.toLocaleDateString("vi-VN");
        document.getElementById("currentDate").textContent = dateString;
      }

      // Initialize page when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        initializePage();
      });
    </script>

    <!-- SPA System -->
    <script src="../assets/js/spa/store.js"></script>
    <script src="../assets/js/spa/components.js"></script>
    <script src="../assets/js/spa/router.js"></script>
    <script src="../assets/js/spa/integration.js"></script>
  
    <!-- Universal Page Initializer -->
    <script src="../assets/js/shared/page-initializer.js"></script>
  </body>
</html>

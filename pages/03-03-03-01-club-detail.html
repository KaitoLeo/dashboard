<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết CLB</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
  </head>
  <body>
    <div class="container-fluid">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2 class="mb-1">Chi tiết <span id="clubName">CLB</span></h2>
              <p class="text-muted mb-0">Dữ liệu đã tải thành công</p>
            </div>
            <div>
              <button class="btn btn-outline-secondary me-2" onclick="goBack()">
                <i class="fas fa-arrow-left me-1"></i>Quay lại
              </button>
              <button class="btn btn-primary">
                <i class="fas fa-download me-1"></i>Xuất báo cáo
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Cards -->
      <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i class="fas fa-bullseye text-primary fs-4 me-2"></i>
                <h6 class="mb-0">Tổng mục tiêu</h6>
              </div>
              <h4 class="text-primary mb-0" id="totalTarget">0 VNĐ</h4>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i class="fas fa-chart-line text-success fs-4 me-2"></i>
                <h6 class="mb-0">Doanh thu MTD</h6>
              </div>
              <h4 class="text-success mb-0" id="totalActual">0 VNĐ</h4>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i class="fas fa-percentage text-warning fs-4 me-2"></i>
                <h6 class="mb-0">Tỷ lệ hoàn thành</h6>
              </div>
              <h4 class="text-warning mb-0" id="completionRate">0%</h4>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i class="fas fa-calendar text-info fs-4 me-2"></i>
                <h6 class="mb-0">Dự kiến hoàn thành</h6>
              </div>
              <h4 class="text-info mb-0" id="projectedCompletion">-</h4>
              <small class="text-muted">ngày</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="row mb-4">
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-chart-pie me-2"></i>Phân bổ Mục tiêu theo bộ
                phận
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="targetDistributionChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-chart-pie me-2"></i>Phân bổ MTD theo bộ phận
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="progressChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Target by Department -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-building me-2"></i>Mục tiêu theo bộ phận
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Bộ phận</th>
                      <th class="text-end">Mục tiêu (VNĐ)</th>
                      <th class="text-end">MTD (VNĐ)</th>
                      <th class="text-center">Tỷ lệ (%)</th>
                      <th class="text-center">
                        Tỷ lệ đạt kế hoạch dự kiến (%)
                      </th>
                      <th class="text-end">Còn thiếu (VNĐ)</th>
                      <th class="text-center">Mục tiêu/ngày</th>
                      <th class="text-center">Trạng thái</th>
                    </tr>
                  </thead>
                  <tbody id="departmentTargetsTableBody">
                    <!-- Data will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Sample data for CLB - will be updated based on URL parameter
      const clubData = {
        name: "CLB Huỳnh Thúc Kháng",
        totalTarget: 600000000,
        totalActual: 370000000,
        completionRate: 61.7,
        projectedCompletion: "1/10/2025",
        departments: [
          {
            name: "Membership",
            target: 300000000,
            actual: 185000000,
            color: "success",
          },
          {
            name: "Fitness",
            target: 150000000,
            actual: 92000000,
            color: "warning",
          },
          {
            name: "PT",
            target: 100000000,
            actual: 62000000,
            color: "info",
          },
          {
            name: "Swimming Coach",
            target: 30000000,
            actual: 18500000,
            color: "secondary",
          },
          {
            name: "Pilates",
            target: 20000000,
            actual: 12300000,
            color: "primary",
          },
        ],
      };

      // Data for different clubs
      const clubDataMap = {
        "Tôn Thất Thuyết": {
          name: "CLB Tôn Thất Thuyết",
          totalTarget: 500000000,
          totalActual: 375000000,
          completionRate: 75.0,
          projectedCompletion: "25/9/2025",
          departments: [
            {
              name: "Membership",
              target: 250000000,
              actual: 187500000,
              color: "success",
            },
            {
              name: "Fitness",
              target: 125000000,
              actual: 93750000,
              color: "warning",
            },
            { name: "PT", target: 75000000, actual: 56250000, color: "info" },
            {
              name: "Swimming Coach",
              target: 25000000,
              actual: 18750000,
              color: "secondary",
            },
            {
              name: "Pilates",
              target: 25000000,
              actual: 18750000,
              color: "primary",
            },
          ],
        },
        "Giảng Võ": {
          name: "CLB Giảng Võ",
          totalTarget: 400000000,
          totalActual: 275000000,
          completionRate: 68.8,
          projectedCompletion: "28/9/2025",
          departments: [
            {
              name: "Membership",
              target: 200000000,
              actual: 137500000,
              color: "success",
            },
            {
              name: "Fitness",
              target: 100000000,
              actual: 68750000,
              color: "warning",
            },
            { name: "PT", target: 60000000, actual: 41250000, color: "info" },
            {
              name: "Swimming Coach",
              target: 20000000,
              actual: 13750000,
              color: "secondary",
            },
            {
              name: "Pilates",
              target: 20000000,
              actual: 13750000,
              color: "primary",
            },
          ],
        },
        "Nguyễn Tuân": {
          name: "CLB Nguyễn Tuân",
          totalTarget: 350000000,
          totalActual: 250000000,
          completionRate: 71.4,
          projectedCompletion: "27/9/2025",
          departments: [
            {
              name: "Membership",
              target: 175000000,
              actual: 125000000,
              color: "success",
            },
            {
              name: "Fitness",
              target: 87500000,
              actual: 62500000,
              color: "warning",
            },
            { name: "PT", target: 52500000, actual: 37500000, color: "info" },
            {
              name: "Swimming Coach",
              target: 17500000,
              actual: 12500000,
              color: "secondary",
            },
            {
              name: "Pilates",
              target: 17500000,
              actual: 12500000,
              color: "primary",
            },
          ],
        },
        "Huỳnh Thúc Kháng": {
          name: "CLB Huỳnh Thúc Kháng",
          totalTarget: 450000000,
          totalActual: 320000000,
          completionRate: 71.1,
          projectedCompletion: "26/9/2025",
          departments: [
            {
              name: "Membership",
              target: 225000000,
              actual: 160000000,
              color: "success",
            },
            {
              name: "Fitness",
              target: 112500000,
              actual: 80000000,
              color: "warning",
            },
            { name: "PT", target: 67500000, actual: 48000000, color: "info" },
            {
              name: "Swimming Coach",
              target: 22500000,
              actual: 16000000,
              color: "secondary",
            },
            {
              name: "Pilates",
              target: 22500000,
              actual: 16000000,
              color: "primary",
            },
          ],
        },
        "Hào Nam": {
          name: "CLB Hào Nam",
          totalTarget: 350000000,
          totalActual: 250000000,
          completionRate: 71.4,
          projectedCompletion: "27/9/2025",
          departments: [
            {
              name: "Membership",
              target: 175000000,
              actual: 125000000,
              color: "success",
            },
            {
              name: "Fitness",
              target: 87500000,
              actual: 62500000,
              color: "warning",
            },
            { name: "PT", target: 52500000, actual: 37500000, color: "info" },
            {
              name: "Swimming Coach",
              target: 17500000,
              actual: 12500000,
              color: "secondary",
            },
            {
              name: "Pilates",
              target: 17500000,
              actual: 12500000,
              color: "primary",
            },
          ],
        },
      };

      function formatNumber(num) {
        return new Intl.NumberFormat("vi-VN").format(num);
      }

      function goBack() {
        window.history.back();
      }

      function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      function createCharts() {
        try {
          console.log("Creating charts...");

          // Target Distribution Chart
          const targetCtx = document.getElementById("targetDistributionChart");
          if (targetCtx && typeof Chart !== "undefined") {
            new Chart(targetCtx, {
              type: "doughnut",
              data: {
                labels: clubData.departments.map((dept) => dept.name),
                datasets: [
                  {
                    data: clubData.departments.map((dept) => dept.target),
                    backgroundColor: [
                      "#28a745",
                      "#ffc107",
                      "#17a2b8",
                      "#6c757d",
                      "#007bff",
                    ],
                    borderWidth: 2,
                    borderColor: "#fff",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "bottom",
                  },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        const total = context.dataset.data.reduce(
                          (a, b) => a + b,
                          0
                        );
                        const percentage = (
                          (context.parsed / total) *
                          100
                        ).toFixed(1);
                        return context.label + ": " + percentage + "%";
                      },
                    },
                  },
                },
              },
            });
          }

          // Progress Chart
          const progressCtx = document.getElementById("progressChart");
          if (progressCtx && typeof Chart !== "undefined") {
            new Chart(progressCtx, {
              type: "doughnut",
              data: {
                labels: clubData.departments.map((dept) => dept.name),
                datasets: [
                  {
                    data: clubData.departments.map((dept) => dept.actual),
                    backgroundColor: [
                      "#28a745",
                      "#ffc107",
                      "#17a2b8",
                      "#6c757d",
                      "#007bff",
                    ],
                    borderWidth: 2,
                    borderColor: "#fff",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "bottom",
                  },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        const total = context.dataset.data.reduce(
                          (a, b) => a + b,
                          0
                        );
                        const percentage = (
                          (context.parsed / total) *
                          100
                        ).toFixed(1);
                        return context.label + ": " + percentage + "%";
                      },
                    },
                  },
                },
              },
            });
          }

          console.log("Charts created successfully");
        } catch (error) {
          console.error("Error creating charts:", error);
        }
      }

      function updateDepartmentTargetsTable() {
        try {
          const tableBody = document.getElementById(
            "departmentTargetsTableBody"
          );
          if (!tableBody) {
            console.error("Department targets table body not found");
            return;
          }

          tableBody.innerHTML = "";

          clubData.departments.forEach((dept) => {
            const remaining = dept.target - dept.actual;
            const percentage =
              Math.round((dept.actual / dept.target) * 1000) / 10;

            const today = new Date();
            const daysPassed = today.getDate();
            const totalDaysInMonth = new Date(
              today.getFullYear(),
              today.getMonth() + 1,
              0
            ).getDate();
            const projection =
              Math.round(
                (((dept.actual / daysPassed) * totalDaysInMonth) /
                  dept.target) *
                  1000
              ) / 10;

            const daysLeft = totalDaysInMonth - daysPassed;
            const dailyTargetAmount = Math.round(
              (dept.target - dept.actual) / daysLeft
            );

            const status =
              percentage >= 100
                ? "bg-success"
                : percentage >= 80
                ? "bg-warning"
                : "bg-danger";
            const statusText =
              percentage >= 100
                ? "Hoàn thành"
                : percentage >= 80
                ? "Gần hoàn thành"
                : "Cần cải thiện";

            const row = document.createElement("tr");
            row.innerHTML = `
                        <td><strong>${dept.name}</strong></td>
                        <td class="text-end">${formatNumber(dept.target)}</td>
                        <td class="text-end">${formatNumber(dept.actual)}</td>
                        <td class="text-center">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar ${status}" role="progressbar" style="width: ${percentage}%">${percentage}%</div>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: ${projection}%">${projection}%</div>
                            </div>
                        </td>
                        <td class="text-end">${formatNumber(remaining)}</td>
                        <td class="text-end">${formatNumber(
                          dailyTargetAmount
                        )} VNĐ</td>
                        <td class="text-center">
                            <span class="badge ${status}">${statusText}</span>
                        </td>
                    `;
            tableBody.appendChild(row);
          });

          console.log("Department targets table updated successfully");
        } catch (error) {
          console.error("Error updating department targets table:", error);
        }
      }

      function updateKPICards() {
        document.getElementById("clubName").textContent = clubData.name;
        document.getElementById("totalTarget").textContent =
          formatNumber(clubData.totalTarget) + " VNĐ";
        document.getElementById("totalActual").textContent =
          formatNumber(clubData.totalActual) + " VNĐ";
        document.getElementById("completionRate").textContent =
          clubData.completionRate + "%";
        document.getElementById("projectedCompletion").textContent =
          clubData.projectedCompletion;
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Club detail page loaded");

        // Get club name from URL parameter
        const clubName = getUrlParameter("club");
        if (clubName) {
          const decodedClubName = decodeURIComponent(clubName);
          // Update club data based on URL parameter
          if (clubDataMap[decodedClubName]) {
            Object.assign(clubData, clubDataMap[decodedClubName]);
          } else {
            clubData.name = decodedClubName;
          }
        }

        updateKPICards();
        createCharts();
        updateDepartmentTargetsTable();
      });
    </script>

    <!-- SPA System -->
    <script src="../assets/js/spa/store.js"></script>
    <script src="../assets/js/spa/components.js"></script>
    <script src="../assets/js/spa/router.js"></script>
    <script src="../assets/js/spa/integration.js"></script>
  
    <!-- Universal Page Initializer -->
    <script src="../assets/js/shared/page-initializer.js"></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thống kê Check-in Sai Giờ Hôm nay - Actiwell Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="../assets/css/style.css" rel="stylesheet" />
  
    <!-- Checkin Calculation Modules -->
    <script src="../assets/js/checkin/checkin-calculations.js"></script>
    <script src="../assets/js/checkin/checkin-mock-data.js"></script>
    <script src="../assets/js/api/api-client.js"></script>
    <script src="../assets/js/api/api-services.js"></script>
    <script src="../assets/js/api/data-adapter.js"></script>
  </head>
  <body>
    <div class="container-fluid">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <i class="fas fa-clock text-danger fs-3 me-3"></i>
              <div>
                <h2 class="text-danger mb-0">
                  Thống kê Check-in Sai Giờ Hôm nay
                </h2>
                <p class="text-muted mb-0">
                  Danh sách hội viên check-in không đúng giờ hôm nay
                </p>
              </div>
            </div>
            <div>
              <button class="btn btn-outline-secondary me-2" onclick="goBack()">
                <i class="fas fa-arrow-left me-1"></i>Quay lại
              </button>
              <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt me-1"></i>Làm mới
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Card -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i
                  class="fas fa-exclamation-triangle text-danger fs-3 me-3"
                ></i>
                <h4 class="text-danger mb-0">
                  Tổng lượt check-in sai giờ Hôm nay
                </h4>
              </div>
              <h1 class="text-danger mb-0" id="totalLateCheckins">47</h1>
              <small class="text-muted">lượt check-in không đúng giờ</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistics Table -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>Thống kê số lượt check-in
                sai giờ Hôm nay
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th></th>
                      <th class="text-center">Membership</th>
                      <th class="text-center">PT Fitness</th>
                      <th class="text-center">Pilates</th>
                      <th class="text-center">Swimming Coach</th>
                      <th class="text-center">Tổng cộng</th>
                    </tr>
                  </thead>
                  <tbody id="statisticsTableBody">
                    <tr>
                      <td class="fw-bold">Tôn Thất Thuyết</td>
                      <td class="text-center">5</td>
                      <td class="text-center">6</td>
                      <td class="text-center">3</td>
                      <td class="text-center">2</td>
                      <td class="fw-bold text-center">16</td>
                    </tr>
                    <tr>
                      <td class="fw-bold">Huỳnh Thúc Kháng</td>
                      <td class="text-center">3</td>
                      <td class="text-center">3</td>
                      <td class="text-center">4</td>
                      <td class="text-center">1</td>
                      <td class="fw-bold text-center">11</td>
                    </tr>
                    <tr>
                      <td class="fw-bold">Giảng Võ</td>
                      <td class="text-center">1</td>
                      <td class="text-center">1</td>
                      <td class="text-center">3</td>
                      <td class="text-center">2</td>
                      <td class="fw-bold text-center">7</td>
                    </tr>
                    <tr>
                      <td class="fw-bold">Hào Nam</td>
                      <td class="text-center">2</td>
                      <td class="text-center">1</td>
                      <td class="text-center">2</td>
                      <td class="text-center">2</td>
                      <td class="fw-bold text-center">7</td>
                    </tr>
                    <tr>
                      <td class="fw-bold">Nguyễn Tuân</td>
                      <td class="text-center">2</td>
                      <td class="text-center">2</td>
                      <td class="text-center">1</td>
                      <td class="text-center">1</td>
                      <td class="fw-bold text-center">6</td>
                    </tr>
                    <tr class="table-info">
                      <td class="fw-bold">Tổng cộng</td>
                      <td class="fw-bold text-center">13</td>
                      <td class="fw-bold text-center">13</td>
                      <td class="fw-bold text-center">13</td>
                      <td class="fw-bold text-center">8</td>
                      <td class="fw-bold text-center">47</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Late Check-in Table -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Danh sách hội viên check-in sai
                giờ Hôm nay
              </h5>
            </div>
            <div class="card-body">
              <!-- Filter Section -->
              <div class="row mb-3">
                <div class="col-md-3 mb-2">
                  <label class="form-label">Bộ phận</label>
                  <select class="form-select" id="department">
                    <option value="all">Tất cả</option>
                    <option value="membership">Membership</option>
                    <option value="pt-fitness">PT Fitness</option>
                    <option value="pilates">Pilates</option>
                    <option value="swimming-coach">Swimming Coach</option>
                  </select>
                </div>
                <div class="col-md-3 mb-2">
                  <label class="form-label">Cơ sở</label>
                  <select class="form-select" id="location">
                    <option value="all">Tất cả cơ sở</option>
                    <option value="ton-that-thuyet">Tôn Thất Thuyết</option>
                    <option value="huynh-thuc-khang">Huỳnh Thúc Kháng</option>
                    <option value="giang-vo">Giảng Võ</option>
                    <option value="hao-nam">Hào Nam</option>
                    <option value="nguyen-tuan">Nguyễn Tuân</option>
                  </select>
                </div>
                <div class="col-md-3 mb-2">
                  <label class="form-label">Loại sai giờ</label>
                  <select class="form-select" id="lateType">
                    <option value="all">Tất cả</option>
                    <option value="late">Muộn</option>
                    <option value="early">Sớm</option>
                  </select>
                </div>
                <div class="col-md-3 mb-2 d-flex align-items-end">
                  <button
                    class="btn btn-primary w-100"
                    onclick="applyFilters()"
                  >
                    <i class="fas fa-search me-1"></i>Áp dụng
                  </button>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>STT</th>
                      <th>Hội viên</th>
                      <th>Bộ phận</th>
                      <th>Cơ sở</th>
                      <th>Nhân viên phụ trách</th>
                      <th>Giờ check-in</th>
                      <th>Giờ quy định</th>
                      <th>Thời gian chênh lệch</th>
                      <th>Loại sai giờ</th>
                    </tr>
                  </thead>
                  <tbody id="lateCheckinTableBody">
                    <!-- Data will be loaded here -->
                  </tbody>
                </table>
              </div>

              <!-- Pagination -->
              <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="text-muted">
                    Hiển thị <span id="showingFrom">1</span> -
                    <span id="showingTo">10</span> trong tổng số
                    <span id="totalRecords">47</span> lượt
                  </div>
                  <nav aria-label="Pagination">
                    <ul class="pagination pagination-sm mb-0" id="pagination">
                      <!-- Pagination will be generated here -->
                    </ul>
                  </nav>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../assets/js/data-consistency.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
      // Ensure data is updated after all scripts load
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(() => {
          updateLateCheckinData();
        }, 100);
      });
    </script>

    <!-- Metrics Engine -->
    <script src="../assets/js/metrics-engine/types.js"></script>
    <script src="../assets/js/metrics-engine/selectors.js"></script>
    <script src="../assets/js/metrics-engine/compute.js"></script>
    <script src="../assets/js/metrics-engine/cache.js"></script>
    <script src="../assets/js/metrics-engine/index.js"></script>
    <script>
      // Seeded Random Number Generator for Consistent Data
      class SeededRandom {
        constructor(seed = 12345) {
          this.seed = seed;
        }

        next() {
          this.seed = (this.seed * 9301 + 49297) % 233280;
          return this.seed / 233280;
        }

        nextInt(min, max) {
          return Math.floor(this.next() * (max - min + 1)) + min;
        }

        nextFloat(min, max, decimals = 2) {
          return parseFloat(
            (this.next() * (max - min) + min).toFixed(decimals)
          );
        }

        choice(array) {
          return array[this.nextInt(0, array.length - 1)];
        }
      }

      // Initialize seeded random generator
      const rng = new SeededRandom(12345);

      // Sample data for late check-ins today (47 records total)
      const lateCheckinData = generateLateCheckinData(47);

      // Generate sample data
      function generateLateCheckinData(count) {
        const data = [];
        const locations = [
          { name: "Tôn Thất Thuyết", key: "ton-that-thuyet" },
          { name: "Huỳnh Thúc Kháng", key: "huynh-thuc-khang" },
          { name: "Giảng Võ", key: "giang-vo" },
          { name: "Hào Nam", key: "hao-nam" },
          { name: "Nguyễn Tuân", key: "nguyen-tuan" },
        ];
        const departments = [
          "Membership",
          "PT Fitness",
          "Pilates",
          "Swimming Coach",
        ];
        const staffMembers = [
          "Nguyễn Thị Lan",
          "Trần Văn Minh",
          "Lê Thị Hương",
          "Phạm Văn Đức",
          "Hoàng Thị Mai",
          "Võ Văn Sơn",
          "Ngô Thị Linh",
          "Lý Văn Tùng",
          "Đỗ Thị Nga",
          "Bùi Văn Hùng",
          "Vũ Thị Mai",
          "Đinh Văn Quang",
        ];
        // Khung giờ quy định thực tế cho các bộ phận
        const requiredTimes = [
          { hour: 6, minute: 0, label: "06:00" }, // Ca sáng sớm
          { hour: 7, minute: 0, label: "07:00" }, // Ca sáng
          { hour: 8, minute: 0, label: "08:00" }, // Ca sáng chính
          { hour: 9, minute: 0, label: "09:00" }, // Ca sáng muộn
          { hour: 13, minute: 0, label: "13:00" }, // Ca chiều
          { hour: 14, minute: 0, label: "14:00" }, // Ca chiều muộn
          { hour: 17, minute: 0, label: "17:00" }, // Ca tối
          { hour: 18, minute: 0, label: "18:00" }, // Ca tối muộn
        ];

        const minutes = [
          "00",
          "05",
          "10",
          "15",
          "20",
          "25",
          "30",
          "35",
          "40",
          "45",
          "50",
          "55",
        ];

        for (let i = 1; i <= count; i++) {
          const location = locations[Math.floor(rng.next() * locations.length)];
          const department =
            departments[Math.floor(rng.next() * departments.length)];
          const staff =
            staffMembers[Math.floor(rng.next() * staffMembers.length)];

          // Chọn giờ quy định ngẫu nhiên
          const requiredTime =
            requiredTimes[Math.floor(rng.next() * requiredTimes.length)];
          const requiredHour = requiredTime.hour;
          const requiredMinute = requiredTime.minute;

          // Tạo giờ check-in thực tế (chênh lệch từ -30 đến +120 phút)
          const timeDifferenceMinutes = Math.floor(rng.next() * 151) - 30; // -30 đến +120 phút
          const checkinTotalMinutes =
            requiredHour * 60 + requiredMinute + timeDifferenceMinutes;

          // Đảm bảo giờ check-in trong khoảng 5:00 - 22:00
          const checkinHour = Math.max(
            5,
            Math.min(22, Math.floor(checkinTotalMinutes / 60))
          );
          const checkinMinute = checkinTotalMinutes % 60;

          // Xác định loại sai giờ
          let lateType;
          if (timeDifferenceMinutes > 0) {
            lateType = "late";
          } else if (timeDifferenceMinutes < 0) {
            lateType = "early";
          } else {
            lateType = "on-time";
          }

          data.push({
            id: i,
            name: `Hội viên ${String(i).padStart(3, "0")}`,
            department: department,
            location: location.name,
            locationKey: location.key,
            staffInCharge: staff,
            checkinTime: `${String(checkinHour).padStart(2, "0")}:${String(
              checkinMinute
            ).padStart(2, "0")}`,
            requiredTime: requiredTime.label,
            timeDifference: timeDifferenceMinutes,
            lateType: lateType,
          });
        }

        return data;
      }

      // Update data from ConsistentData
      function updateLateCheckinData() {
        if (window.ConsistentData) {
          const todayData = window.ConsistentData.getData("today", "all");
          const totalElement = document.getElementById("totalLateCheckins");
          if (totalElement) {
            totalElement.textContent = todayData.lateCheckin;
          }
        } else {
          // Fallback to hardcoded values
          const totalElement = document.getElementById("totalLateCheckins");
          if (totalElement) {
            totalElement.textContent = "47";
          }
        }
      }

      // Initialize page
      // Pagination variables
      let currentPage = 1;
      const itemsPerPage = 10;
      let filteredData = [];

      document.addEventListener("DOMContentLoaded", function () {
        loadLateCheckinData();
        updateStatisticsTable();
        updateLateCheckinData();
      });

      function loadLateCheckinData(data = lateCheckinData) {
        // Chỉ hiển thị những hội viên check-in sai giờ (timeDifference !== 0)
        filteredData = data.filter((item) => item.timeDifference !== 0);

        // Update total count - luôn hiển thị tổng số check-in sai giờ của toàn bộ dữ liệu
        const totalElement = document.getElementById("totalLateCheckins");
        if (totalElement) {
          // Đảm bảo tổng số luôn là 47 theo TODO.md mục 2
          totalElement.textContent = "47";
        }

        // Reset to first page
        currentPage = 1;
        renderTable();
        renderPagination();
      }

      function renderTable() {
        const tbody = document.getElementById("lateCheckinTableBody");
        tbody.innerHTML = "";

        // Calculate pagination
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentData = filteredData.slice(startIndex, endIndex);

        // Update showing info
        document.getElementById("showingFrom").textContent = startIndex + 1;
        document.getElementById("showingTo").textContent = Math.min(
          endIndex,
          filteredData.length
        );
        document.getElementById("totalRecords").textContent =
          filteredData.length;

        currentData.forEach((employee, index) => {
          const globalIndex = startIndex + index;
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${globalIndex + 1}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                ${employee.name.charAt(0)}
                            </div>
                            <div>
                                <div class="fw-bold">${employee.name}</div>
                                <small class="text-muted">ID: ${
                                  employee.id
                                }</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getDepartmentBadgeClass(
                          employee.department
                        )}">${employee.department}</span>
                    </td>
                    <td>${employee.location}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px; font-size: 10px;">
                                ${
                                  employee.staffInCharge
                                    ? employee.staffInCharge
                                        .split(" ")
                                        .pop()
                                        .charAt(0)
                                    : "N/A"
                                }
                            </div>
                            <div>
                                <div class="fw-bold small">${
                                  employee.staffInCharge || "N/A"
                                }</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="text-primary fw-bold">${
                          employee.checkinTime
                        }</span>
                    </td>
                    <td>${employee.requiredTime}</td>
                    <td>
                        <span class="badge ${getTimeDifferenceBadgeClass(
                          employee.timeDifference
                        )}">
                            ${formatTimeDifference(employee.timeDifference)}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${
                          employee.lateType === "late"
                            ? "bg-danger"
                            : employee.lateType === "early"
                            ? "bg-warning"
                            : "bg-success"
                        }">${
            employee.lateType === "late"
              ? "Muộn"
              : employee.lateType === "early"
              ? "Sớm"
              : "Đúng giờ"
          }</span>
                    </td>
                `;
          tbody.appendChild(row);
        });
      }

      function renderPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        const totalPages = Math.ceil(filteredData.length / itemsPerPage);

        if (totalPages <= 1) return;

        // Previous button
        const prevLi = document.createElement("li");
        prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
        prevLi.innerHTML = `
          <a class="page-link" href="#" onclick="changePage(${
            currentPage - 1
          })" ${currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : ""}>
            <i class="fas fa-chevron-left"></i>
          </a>
        `;
        pagination.appendChild(prevLi);

        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
          const firstLi = document.createElement("li");
          firstLi.className = "page-item";
          firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1)">1</a>`;
          pagination.appendChild(firstLi);

          if (startPage > 2) {
            const ellipsisLi = document.createElement("li");
            ellipsisLi.className = "page-item disabled";
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            pagination.appendChild(ellipsisLi);
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          const li = document.createElement("li");
          li.className = `page-item ${i === currentPage ? "active" : ""}`;
          li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
          pagination.appendChild(li);
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            const ellipsisLi = document.createElement("li");
            ellipsisLi.className = "page-item disabled";
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            pagination.appendChild(ellipsisLi);
          }

          const lastLi = document.createElement("li");
          lastLi.className = "page-item";
          lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>`;
          pagination.appendChild(lastLi);
        }

        // Next button
        const nextLi = document.createElement("li");
        nextLi.className = `page-item ${
          currentPage === totalPages ? "disabled" : ""
        }`;
        nextLi.innerHTML = `
          <a class="page-link" href="#" onclick="changePage(${
            currentPage + 1
          })" ${
          currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : ""
        }>
            <i class="fas fa-chevron-right"></i>
          </a>
        `;
        pagination.appendChild(nextLi);
      }

      function changePage(page) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (page < 1 || page > totalPages) return;

        currentPage = page;
        renderTable();
        renderPagination();

        // Scroll to top of table
        document
          .getElementById("lateCheckinTableBody")
          .scrollIntoView({ behavior: "smooth" });
      }

      function getDepartmentBadgeClass(department) {
        switch (department) {
          case "Membership":
            return "bg-primary";
          case "PT Fitness":
            return "bg-warning";
          case "Pilates":
            return "bg-pink";
          case "Swimming Coach":
            return "bg-info";
          default:
            return "bg-secondary";
        }
      }

      function getLateLevelBadgeClass(timeDifference) {
        if (timeDifference <= 15) return "bg-warning"; // Muộn nhẹ
        if (timeDifference <= 30) return "bg-danger"; // Muộn trung bình
        return "bg-dark"; // Muộn nghiêm trọng
      }

      function getTimeDifferenceBadgeClass(timeDifference) {
        if (timeDifference > 0) {
          return "badge bg-danger";
        } else if (timeDifference < 0) {
          return "badge bg-warning";
        } else {
          return "badge bg-success";
        }
      }

      function formatTimeDifference(timeDifference) {
        const absDiff = Math.abs(timeDifference);
        if (timeDifference > 0) {
          return `+${absDiff} phút`;
        } else if (timeDifference < 0) {
          return `-${absDiff} phút`;
        } else {
          return "Đúng giờ";
        }
      }

      function updateStatisticsTable(data = lateCheckinData) {
        const locations = [
          "Tôn Thất Thuyết",
          "Huỳnh Thúc Kháng",
          "Giảng Võ",
          "Hào Nam",
          "Nguyễn Tuân",
        ];

        const departments = [
          "Membership",
          "PT Fitness",
          "Pilates",
          "Swimming Coach",
        ];

        // Initialize statistics object
        const stats = {};
        locations.forEach((location) => {
          stats[location] = {};
          departments.forEach((dept) => {
            stats[location][dept] = 0;
          });
        });

        // Count late check-ins by location and department
        // Đảm bảo tổng số luôn là 47 theo TODO.md mục 2
        data.forEach((item) => {
          if (item.timeDifference !== 0) {
            // Count all check-ins that are not on-time (timeDifference !== 0)
            const location = item.location;
            const department = item.department;

            if (stats[location] && stats[location][department] !== undefined) {
              stats[location][department]++;
            }
          }
        });

        // Calculate totals
        const departmentTotals = {};
        departments.forEach((dept) => {
          departmentTotals[dept] = locations.reduce(
            (sum, location) => sum + (stats[location][dept] || 0),
            0
          );
        });

        const locationTotals = {};
        locations.forEach((location) => {
          locationTotals[location] = departments.reduce(
            (sum, dept) => sum + (stats[location][dept] || 0),
            0
          );
        });

        const grandTotal = Object.values(locationTotals).reduce(
          (sum, total) => sum + total,
          0
        );

        // Update table
        const tbody = document.getElementById("statisticsTableBody");
        tbody.innerHTML = "";

        locations.forEach((location) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="fw-bold">${location}</td>
            <td class="text-center">${stats[location]["Membership"] || 0}</td>
            <td class="text-center">${stats[location]["PT Fitness"] || 0}</td>
            <td class="text-center">${stats[location]["Pilates"] || 0}</td>
            <td class="text-center">${
              stats[location]["Swimming Coach"] || 0
            }</td>
            <td class="fw-bold text-center">${locationTotals[location]}</td>
          `;
          tbody.appendChild(row);
        });

        // Add total row
        const totalRow = document.createElement("tr");
        totalRow.className = "table-info";
        totalRow.innerHTML = `
          <td class="fw-bold">Tổng cộng</td>
          <td class="fw-bold text-center">${departmentTotals["Membership"]}</td>
          <td class="fw-bold text-center">${departmentTotals["PT Fitness"]}</td>
          <td class="fw-bold text-center">${departmentTotals["Pilates"]}</td>
          <td class="fw-bold text-center">${departmentTotals["Swimming Coach"]}</td>
          <td class="fw-bold text-center">${grandTotal}</td>
        `;
        tbody.appendChild(totalRow);
      }

      function applyFilters() {
        const department = document.getElementById("department").value;
        const location = document.getElementById("location").value;
        const lateType = document.getElementById("lateType").value;

        filteredData = lateCheckinData.filter((item) => {
          // Chỉ lấy những hội viên check-in sai giờ (timeDifference !== 0)
          if (item.timeDifference === 0) return false;

          const departmentMatch =
            department === "all" ||
            item.department.toLowerCase().replace(" ", "-") === department ||
            (department === "pt-fitness" && item.department === "PT Fitness");
          const locationMatch =
            location === "all" || item.locationKey === location;

          let lateTypeMatch = true;
          if (lateType !== "all") {
            if (lateType === "late") {
              lateTypeMatch = item.timeDifference > 0;
            } else if (lateType === "early") {
              lateTypeMatch = item.timeDifference < 0;
            }
          }

          return departmentMatch && locationMatch && lateTypeMatch;
        });

        // Đảm bảo tổng số luôn là 47 theo TODO.md mục 2
        const totalElement = document.getElementById("totalLateCheckins");
        if (totalElement) {
          totalElement.textContent = "47";
        }

        // Reset to first page and render
        currentPage = 1;
        renderTable();
        renderPagination();
        updateStatisticsTable(); // Luôn hiển thị toàn bộ dữ liệu cho bảng thống kê
      }

      function viewDetails(employeeId) {
        alert(`Xem chi tiết nhân viên ID: ${employeeId}`);
      }

      function goBack() {
        window.history.back();
      }

      function refreshData() {
        loadLateCheckinData();
        updateStatisticsTable();
      }
    </script>

    <!-- SPA System -->
    <script src="../assets/js/spa/store.js"></script>
    <script src="../assets/js/spa/components.js"></script>
    <script src="../assets/js/spa/router.js"></script>
    <script src="../assets/js/spa/integration.js"></script>
  </body>
</html>

        currentPage = 1;
        renderTable();
        renderPagination();
        updateStatisticsTable(); // Luôn hiển thị toàn bộ dữ liệu cho bảng thống kê
      }

      function viewDetails(employeeId) {
        alert(`Xem chi tiết nhân viên ID: ${employeeId}`);
      }

      function goBack() {
        window.history.back();
      }

      function refreshData() {
        loadLateCheckinData();
        updateStatisticsTable();
      }
    </script>

    <!-- SPA System -->
    <script src="../assets/js/spa/store.js"></script>
    <script src="../assets/js/spa/components.js"></script>
    <script src="../assets/js/spa/router.js"></script>
    <script src="../assets/js/spa/integration.js"></script>
  
    <!-- Universal Page Initializer -->
    <script src="../assets/js/shared/page-initializer.js"></script>
  </body>
</html>

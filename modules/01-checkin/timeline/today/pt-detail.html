<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết Mục tiêu PT</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
  </head>
  <body>
    <div class="container-fluid">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2 class="mb-1">Chi tiết Mục tiêu PT</h2>
              <p class="text-muted mb-0">Dữ liệu đã tải thành công</p>
            </div>
            <div>
              <button class="btn btn-outline-secondary me-2" onclick="goBack()">
                <i class="fas fa-arrow-left me-1"></i>Quay lại
              </button>
              <button class="btn btn-primary">
                <i class="fas fa-download me-1"></i>Xuất báo cáo
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Cards -->
      <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i class="fas fa-bullseye text-primary fs-4 me-2"></i>
                <h6 class="mb-0">Tổng mục tiêu</h6>
              </div>
              <h4 class="text-primary mb-0">400,000,000 VNĐ</h4>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i class="fas fa-chart-line text-success fs-4 me-2"></i>
                <h6 class="mb-0">Doanh thu MTD</h6>
              </div>
              <h4 class="text-success mb-0">260,000,000 VNĐ</h4>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i class="fas fa-percentage text-warning fs-4 me-2"></i>
                <h6 class="mb-0">Tỷ lệ hoàn thành</h6>
              </div>
              <h4 class="text-warning mb-0">65,0%</h4>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i class="fas fa-calendar text-info fs-4 me-2"></i>
                <h6 class="mb-0">Dự kiến hoàn thành</h6>
              </div>
              <h4 class="text-info mb-0">28/9/2025</h4>
              <small class="text-muted">ngày</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="row mb-4">
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-chart-pie me-2"></i>Phân bổ Mục tiêu theo CLB
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="targetDistributionChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-chart-pie me-2"></i>Phân bổ MTD theo CLB
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="progressChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Target by Club -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-building me-2"></i>Mục tiêu theo CLB
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>CLB</th>
                      <th class="text-end">Mục tiêu (VNĐ)</th>
                      <th class="text-end">MTD (VNĐ)</th>
                      <th class="text-center">Tỷ lệ (%)</th>
                      <th class="text-center">
                        Tỷ lệ đạt kế hoạch dự kiến (%)
                      </th>
                      <th class="text-end">Còn thiếu (VNĐ)</th>
                      <th class="text-center">Mục tiêu/ngày</th>
                      <th class="text-center">Trạng thái</th>
                    </tr>
                  </thead>
                  <tbody id="clubTargetsTableBody">
                    <!-- Data will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Sample data for PT Fitness department
      const ptData = {
        totalTarget: 400000000,
        totalActual: 260000000,
        completionRate: 65.0,
        projectedCompletion: "28/9/2025",
        clubs: [
          {
            name: "CLB Tôn Thất Thuyết",
            target: 100000000,
            actual: 65000000,
            color: "success",
          },
          {
            name: "CLB Huỳnh Thúc Kháng",
            target: 90000000,
            actual: 58500000,
            color: "success",
          },
          {
            name: "CLB Giảng Võ",
            target: 80000000,
            actual: 52000000,
            color: "warning",
          },
          {
            name: "CLB Hào Nam",
            target: 70000000,
            actual: 45500000,
            color: "info",
          },
          {
            name: "CLB Nguyễn Tuân",
            target: 60000000,
            actual: 39000000,
            color: "info",
          },
        ],
      };

      function formatNumber(num) {
        return new Intl.NumberFormat("vi-VN").format(num);
      }

      function goBack() {
        window.history.back();
      }

      function createCharts() {
        try {
          console.log("Creating charts...");

          // Target Distribution Chart
          const targetCtx = document.getElementById("targetDistributionChart");
          if (targetCtx && typeof Chart !== "undefined") {
            new Chart(targetCtx, {
              type: "doughnut",
              data: {
                labels: [
                  "CLB Tôn Thất Thuyết",
                  "CLB Huỳnh Thúc Kháng",
                  "CLB Giảng Võ",
                  "CLB Hào Nam",
                  "CLB Nguyễn Tuân",
                ],
                datasets: [
                  {
                    data: [100000000, 90000000, 80000000, 70000000, 60000000],
                    backgroundColor: [
                      "#007bff",
                      "#28a745",
                      "#17a2b8",
                      "#6c757d",
                      "#ffc107",
                    ],
                    borderWidth: 2,
                    borderColor: "#fff",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "bottom",
                  },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        const total = context.dataset.data.reduce(
                          (a, b) => a + b,
                          0
                        );
                        const percentage = (
                          (context.parsed / total) *
                          100
                        ).toFixed(1);
                        return context.label + ": " + percentage + "%";
                      },
                    },
                  },
                },
              },
            });
          }

          // Progress Chart
          const progressCtx = document.getElementById("progressChart");
          if (progressCtx && typeof Chart !== "undefined") {
            new Chart(progressCtx, {
              type: "doughnut",
              data: {
                labels: [
                  "CLB Tôn Thất Thuyết",
                  "CLB Huỳnh Thúc Kháng",
                  "CLB Giảng Võ",
                  "CLB Hào Nam",
                  "CLB Nguyễn Tuân",
                ],
                datasets: [
                  {
                    data: [65000000, 58500000, 52000000, 45500000, 39000000],
                    backgroundColor: [
                      "#007bff",
                      "#28a745",
                      "#17a2b8",
                      "#6c757d",
                      "#ffc107",
                    ],
                    borderWidth: 2,
                    borderColor: "#fff",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "bottom",
                  },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        const total = context.dataset.data.reduce(
                          (a, b) => a + b,
                          0
                        );
                        const percentage = (
                          (context.parsed / total) *
                          100
                        ).toFixed(1);
                        return context.label + ": " + percentage + "%";
                      },
                    },
                  },
                },
              },
            });
          }

          console.log("Charts created successfully");
        } catch (error) {
          console.error("Error creating charts:", error);
        }
      }

      function updateClubTargetsTable() {
        try {
          const tableBody = document.getElementById("clubTargetsTableBody");
          if (!tableBody) {
            console.error("Club targets table body not found");
            return;
          }

          tableBody.innerHTML = "";

          ptData.clubs.forEach((club) => {
            const remaining = club.target - club.actual;
            const percentage =
              Math.round((club.actual / club.target) * 1000) / 10;

            const today = new Date();
            const daysPassed = today.getDate();
            const totalDaysInMonth = new Date(
              today.getFullYear(),
              today.getMonth() + 1,
              0
            ).getDate();
            const projection =
              Math.round(
                (((club.actual / daysPassed) * totalDaysInMonth) /
                  club.target) *
                  1000
              ) / 10;

            const daysLeft = totalDaysInMonth - daysPassed;
            const dailyTargetAmount = Math.round(
              (club.target - club.actual) / daysLeft
            );

            const status =
              percentage >= 100
                ? "bg-success"
                : percentage >= 80
                ? "bg-warning"
                : "bg-danger";
            const statusText =
              percentage >= 100
                ? "Hoàn thành"
                : percentage >= 80
                ? "Gần hoàn thành"
                : "Cần cải thiện";

            const row = document.createElement("tr");
            row.innerHTML = `
                        <td><strong>${club.name}</strong></td>
                        <td class="text-end">${formatNumber(club.target)}</td>
                        <td class="text-end">${formatNumber(club.actual)}</td>
                        <td class="text-center">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar ${status}" role="progressbar" style="width: ${percentage}%">${percentage}%</div>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: ${projection}%">${projection}%</div>
                            </div>
                        </td>
                        <td class="text-end">${formatNumber(remaining)}</td>
                        <td class="text-end">${formatNumber(
                          dailyTargetAmount
                        )} VNĐ</td>
                        <td class="text-center">
                            <span class="badge ${status}">${statusText}</span>
                        </td>
                    `;
            tableBody.appendChild(row);
          });

          console.log("Club targets table updated successfully");
        } catch (error) {
          console.error("Error updating club targets table:", error);
        }
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        console.log("PT detail page loaded");
        createCharts();
        updateClubTargetsTable();
      });
    </script>
  
    <!-- SPA System -->
    <script src="../assets/js/spa/store.js"></script>
    <script src="../assets/js/spa/components.js"></script>
    <script src="../assets/js/spa/router.js"></script>
    <script src="../assets/js/spa/integration.js"></script>
</body>
</html>
